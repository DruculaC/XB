C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE NEWSLAVE
OBJECT MODULE PLACED IN .\out\newSlave.obj
COMPILER INVOKED BY: D:\Program Files (x86)\keil\C51\BIN\C51.EXE newSlave.c BROWSE DEBUG OBJECTEXTEND PRINT(.\listing\ne
                    -wSlave.lst) OBJECT(.\out\newSlave.obj)

line level    source

   1          #include"N79E81x.h"
   2          #include<intrins.h>
   3          #include"AD.h"
   4          #include"T0.h"
   5          #include"voice.h"
   6          #include"pwm.h"
   7          #include"T1.h"
   8          
   9          //¶¨ÒåÍ¨ĞÅÃüÁî
  10          
  11          #define CmdStart 0x00 //¿ª»úÃüÁî
  12          #define CmdStop 0x01  //¹Ø»úÃüÁî
  13          
  14          #define ComMode_1 0xc1 //Í¨ĞÅÄ£Ê½1 
  15          #define ComMode_2 0xc2 //Í¨ĞÅÄ£Ê½2
  16          #define ComMode_3 0xc3 //Í¨ĞÅÄ£Ê½3
  17          #define ComMode_4 0xc4 //Ì§ÆğÖ¸Áî
  18          #define ComMode_5 0xc5 //µ¹µØÖ¸Áî
  19          
  20          #define Succeed 0xce  //Í¨ĞÅ³É¹¦
  21          #define Wrong 0xff    //Í¨ĞÅÊ§°Ü
  22          
  23          #define CmdHead 0xc8
  24          #define CmdHead1 0x33 //Êı¾İÖ¡µÄÊ×²¿1, 00110011,11
  25          #define CmdHead2 0xcc //Êı¾İÖ¡µÄÊ×²¿2,11001100,00
  26          #define CmdHead3 0x3c //Êı¾İÖ¡µÄÊ×²¿3,11000011,01
  27          #define CmdHead4 0xcc //Êı¾İÖ¡µÄÊ×²¿4,11001100,00
  28          
  29          #define MyAddress 0xe0
  30          #define MyAddress1 0x33 //±¾»úµØÖ·1, 00110011,11
  31          #define MyAddress2 0x3c //±¾»úµØÖ·2, 11000011,01
  32          #define MyAddress3 0xcc //±¾»úµØÖ·3,11001100,00
  33          #define MyAddress4 0xcc //±¾»úµØÖ·4,11001100,00
  34          
  35          sbit ModeControl_1=P2^6;        //ÎŞÏß·¢Éä»úÄ£Ê½¿ØÖÆ£¬1ÎªĞ¡¹¦ÂÊ£¬0Îª´ó¹¦ÂÊ
  36          sbit tran_en=P2^7;                      //ÎŞÏß·¢Éä»úÊ¹ÄÜ¿ØÖÆ£¬1Îª´ò¿ª·¢Éä»ú£¬0Îª¹Ø±Õ·¢Éä»ú
  37          sbit Moto=P2^4;                         //Âí´ï¿ØÖÆ¶Ë£¬1Âí´ï²»Õñ¶¯£¬0Âí´ïÕñ¶¯
  38          sbit PAshutdown=P1^4;           //¹¦·Å¿ª¹Ø¿ØÖÆ£¬1Îª´ò¿ª¹¦·Å£¬0Îª¹Ø±Õ¹¦·Å
  39          sbit receive_en=P1^3;           //½ÓÊÕ»úÊ¹ÄÜ£¬Òª¼ÓÉÏÀ­µç×è
  40          
  41          bit receiveFlag=0;      //½ÓÊÕµ½Êı¾İ±êÖ¾
  42          bit commuFlag=0;        //¿ªÆôÍ¨ĞÅ±êÖ¾£¬1±íÊ¾¿ªÊ¼Í¨ĞÅ£¬0±íÊ¾Ã»ÓĞÍ¨ĞÅ
  43          bit alarmFlag2=0;       //±àÂë2±¨¾¯±êÖ¾
  44          bit alarmFlag3=0;       //±àÂë3±¨¾¯±êÖ¾
  45          bit alarmFlag4=0;       //Ì§Æğ±¨¾¯±êÖ¾
  46          bit alarmFlag5=0;       //µ¹µØ±¨¾¯±êÖ¾
  47          unsigned char alarmCount2=0;    //±¨¾¯2Ñ­»·´ÎÊı
  48          unsigned char alarmCount3=0;    //±¨¾¯3Ñ­»·´ÎÊı
  49          unsigned char alarmCount4=0;    //Ì§Æğ±¨¾¯Ñ­»·´ÎÊı
  50          unsigned char alarmCount5=0;    //µ¹µØ±¨¾¯Ñ­»·´ÎÊı
  51          
  52          unsigned char count=0;                  //´®¿Ú½ÓÊÕ²¿·ÖµÄ¼ÆÊıÆ÷
  53          unsigned int time0Count_3=0;    //¶¨Ê±Æ÷T0µÄ¼ÆÊı
  54          
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 2   

  55          unsigned char TestFlag=0;               //Ã¿3s¼ÆÊı¼Ó1£¬Èç¹ûÍ¨ĞÅ³É¹¦£¬Ôò½«Æä¹éÁã¡£ÉèÖÃÈç¹ûÁ¬Ğøn´Î¶¼Ã»ÓĞ¹éÁã£¬ÔòËµÃ÷²»ÔÚ³
             -¡ÁË
  56          
  57          //×÷Îª½ÓÊÕºÍ·¢ËÍµÄ»º´æÇø
  58          unsigned char TxRxBuf[28]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
             -,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  59          //Ò»¸öÍ·×Ö½Ú£¬Ò»¸öµØÖ·×Ö½Ú£¬Ò»¸öÃüÁî×Ö½Ú£¬Á½¸ö±àÂëµØÖ·×Ö½Ú£¬Á½¸ö±àÂë
  60          unsigned char myTxRxData[7]={0x00,0x00,0x00,0x00,0x00,0x00,0x00};//´¦ÀíÍêºóµÄÍ¨ĞÅÊı¾İµÄ»º³åÇø
  61           
  62          //Í¨ĞÅÊı¾İ¶¨Òå
  63          unsigned char DataBetween=0;    //×÷Îª½ÓÊÕÊı¾İµÄÖĞ¼ä±äÁ¿
  64          unsigned char RecData=0;                //½ÓÊÕµ½µÄÊı¾İ
  65          unsigned char DataTime=0;               //×÷Îª½ÓÊÕµÄÊı¾İµÄÒÆÎ»´ÎÊı¼ÆÊı
  66          bit ComFlag=1;                                  //¼ì²âÉÏÌøÑØºÍÏÂÌøÑØµÄ±êÊ¶
  67          unsigned char T1highcount=0;    //¶¨Ê±Æ÷T1ÔÚÃ»ÓĞĞÅºÅµ½À´µÄÊ±ºò£¬¶Ô¸ßµçÆ½¼ÆÊı£¬Ò»µ©³¬¹ıÄ³¸öÖµ£¬Ôò½«DatatimeÇå0
  68          
  69          unsigned int Check=0;                   //×÷ÎªAD¼ì²âÖµ£¬¼ì²âµç³ØµçÁ¿
  70           
  71          unsigned char powerflag=1;              //¶¨ÒåµçÑ¹±¨¾¯±êÖ¾Î»
  72          
  73          
  74          void ComMode_1_Data(void);              //±àÂë1º¯Êı
  75          
  76          void Delay3(unsigned int t)             //t=1Ê±£¬ÑÓ³Ù100us×óÓÒ
  77          {
  78   1              unsigned int i,j;
  79   1              for(i=0;i<t;i++)                
  80   1              for(j=0;j<23;j++);
  81   1      }
  82          
  83          void initsignal()                               //init signal£¬·¢ËÍ±àÂëĞÅºÅÇ°µÄÆğÊ¼ĞÅºÅ£¬ÓÃÓÚ½«½ÓÊÕ»úµÄ×Ô¶¯ÔöÒæ´ò¿ª
  84          {
  85   1              unsigned char k,k1;
  86   1              unsigned char mystartbuffer=0xaa;
  87   1              for(k1=0;k1<3;k1++)
  88   1              {
  89   2                      for(k=0;k<1;k++)
  90   2                      {
  91   3                              if((mystartbuffer&0x80)==0x80)//Îª1
  92   3                              {
  93   4                                      P10=0;
  94   4                                      Delay3(80);             //ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
  95   4                              }
  96   3                              else//Îª0µÄÇé¿ö
  97   3                              {
  98   4                                      P10=0;
  99   4                                      Delay3(80);             //ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 100   4                              }
 101   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 102   3                              mystartbuffer<<=1;
 103   3                              Delay3(150);            //ÑÓÊ±Òª´óÓÚ2ms
 104   3                      }
 105   2                      mystartbuffer=0xaa;
 106   2                      Delay3(80);
 107   2              }
 108   1              P10=1;
 109   1      }
 110          
 111          void main(void)
 112          {
 113   1              noVoice();                              //¿ª»ú²»·¢ÉùÒô
 114   1      
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 3   

 115   1              InitT0();                               //³õÊ¼»¯¶¨Ê±Æ÷0ºÍ¶¨Ê±Æ÷1
 116   1              InitT1();
 117   1      
 118   1              Moto=1;                                 //¹Ø±ÕÂí´ï
 119   1              tran_en=0;                              //¹Ø±Õ·¢Éä»ú
 120   1              receive_en=0;                   //¹Ø±Õ½ÓÊÕ»ú
 121   1              ET0=1;                                  //Ê¹ÄÜ¶¨Ê±Æ÷0ºÍ1µÄÖĞ¶Ï
 122   1              ET1=1;
 123   1              PT1=1;                                  //ÉèÖÃ¶¨Ê±Æ÷1Îª½Ï¸ßÓÅÏÈ¼¶
 124   1              EA=1;                                   //ËùÓĞÖĞ¶ÏÊ¹ÄÜ
 125   1      
 126   1              myPwm();                                //·½²¨Êä³ö´ò¿ª
 127   1      
 128   1              P10=1;                                  //·¢Éä¶Ë¿Ú£¬ÏÈÖÃÎª¸ß
 129   1      
 130   1              PAshutdown=0;                   //¿ª»úÊ±£¬½«¹¦·Å¹Ø±Õ
 131   1              Check=GetADCResult(6);  //Ö´ĞĞÒ»´Îµç³ØµçÁ¿¼ì²â
 132   1      
 133   1              PAshutdown=1;
 134   1              SC_Speech(4);
 135   1              Delay(200);
 136   1              PAshutdown=0;
 137   1              commuFlag=1;//¿ªÆôÍ¨ĞÅ
 138   1      
 139   1              while(1)
 140   1              {
 141   2                      if((alarmFlag2==1)&&(alarmCount2<2))    //±àÂë2¿ªÊ¼ÏàÓ¦µÄ±¨¾¯
 142   2                      {
 143   3                              alarmCount2++;
 144   3      
 145   3                              PAshutdown=1;
 146   3                              SC_Speech(1);
 147   3                              Delay(160);
 148   3                              PAshutdown=0;                   
 149   3      
 150   3                              Moto=0;         //¿ªÕğ¶¯
 151   3                              Delay(10);
 152   3                              Moto=1;
 153   3                      }
 154   2                      if((alarmFlag3==1)&&(alarmCount3<2))    //±àÂë3¿ªÊ¼ÏàÓ¦µÄ±¨¾¯
 155   2                      {
 156   3                              alarmCount3++;
 157   3                              
 158   3                              PAshutdown=1;
 159   3                              SC_Speech(11);
 160   3                              Delay(150);
 161   3                              Moto=0;         //¿ªÕğ¶¯
 162   3                              Delay(20);
 163   3                              Moto=1;
 164   3                              PAshutdown=0;   
 165   3                      }
 166   2      
 167   2                      if((powerflag==1)&&(Check<=0x35a))
 168   2                      {
 169   3                              powerflag=0;
 170   3                              PAshutdown=1;
 171   3                              SC_Speech(7);   //µçÑ¹²»³ä×ãÌáÊ¾
 172   3                              Delay(120);
 173   3                              PAshutdown=0;
 174   3                      }
 175   2                      else if((powerflag==0)&&(Check>=0x377))
 176   2                      {
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 4   

 177   3                              powerflag=1;
 178   3                              PAshutdown=1;
 179   3                              SC_Speech(6);   //µçÑ¹³ä×ãÌáÊ¾
 180   3                              Delay(120);
 181   3                              PAshutdown=0;
 182   3                      }
 183   2              }
 184   1      }
 185          
 186          void timeT1() interrupt 3               //¶¨Ê±Æ÷1ÖĞ¶Ï½ÓÊÕÊı¾İ
 187          {
 188   1      //      unsigned int newAddr=0;
 189   1              TH1=timer1H;                            //ÖØ×°ÔØ
 190   1              TL1=timer1L;
 191   1         
 192   1              if(P11==0)                                      //Õı³£Çé¿öÎª¸ßµçÆ½,ÓĞµÍµçÆ½ËµÃ÷ÓĞĞÅºÅ
 193   1              {
 194   2                      DataBetween++;
 195   2                      ComFlag=0;
 196   2                      if(DataBetween==150)    //µÍµçÆ½³ÖĞøµÄ×î´óÊ±¼ä  
 197   2                      {
 198   3                              DataBetween=0;
 199   3                      }
 200   2              }
 201   1              else                                            //Îª¸ßµçÆ½ÁË
 202   1              {
 203   2                      if(ComFlag==0)                  //ËµÃ÷ÓĞÒ»¸öµÍµçÆ½
 204   2                      {
 205   3                              ComFlag=1;
 206   3                              if((DataBetween>60)&&(DataBetween<=100))        //µÍµçÆ½³ÖĞøµÄÊ±¼äĞ¡ÓÚ10ms£¬ÔòÎª0
 207   3                              {
 208   4                                      RecData<<=1;
 209   4                                      RecData &= 0xfe;
 210   4                                      DataTime++;
 211   4                                      T1highcount=0;
 212   4                              }
 213   3                              else if((DataBetween>100))                                      //µÍµçÆ½³ÖĞøµÄÊ±¼ä´óÓÚ10ms£¬ÔòÎª1
 214   3                              {
 215   4                                      RecData<<=1;
 216   4                                      RecData |= 0x01;
 217   4                                      DataTime++;
 218   4                                      T1highcount=0;
 219   4                              }
 220   3                              else
 221   3                              {
 222   4                                      T1highcount++;  
 223   4                              }
 224   3                              DataBetween=0;
 225   3                      }
 226   2                      else
 227   2                      {
 228   3                              T1highcount++;
 229   3                              if(T1highcount>=120)
 230   3                              {
 231   4                                      DataTime=0;
 232   4                                      ComFlag=1;
 233   4                                      count=0;
 234   4                              }               
 235   3                      }
 236   2              }
 237   1      
 238   1              if(DataTime==8)                                 //ËµÃ÷Ò»¸ö×Ö½ÚµÄÊı¾İÒÑ¾­½ÓÊÜÍêÈ«
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 5   

 239   1              {
 240   2                      DataTime=0;
 241   2                      myTxRxData[count]=RecData;
 242   2                      if(count==0&&myTxRxData[0]==CmdHead)
 243   2                      {
 244   3                              count=1;
 245   3                      }
 246   2                      else if(count==1&&myTxRxData[1]==MyAddress)
 247   2                      {
 248   3                              count=2;
 249   3                      }
 250   2                      else if(count>=2&&count<=5)
 251   2                      {
 252   3                              count++;
 253   3                      }
 254   2                      else if(count==6)
 255   2                      {
 256   3                              receiveFlag=1;
 257   3                              count=0;
 258   3                      }
 259   2                      else 
 260   2                      {
 261   3                              count=0;
 262   3                      }
 263   2              }
 264   1      
 265   1              if(receiveFlag==1)                      //ËµÃ÷½ÓÊÕµ½ÁËÊı¾İ£¬¿ªÊ¼´¦Àí
 266   1              {
 267   2                      receiveFlag=0;                  //Çå½ÓÊÕ±êÖ¾
 268   2                      receive_en=0;                   //¹Ø±Õ½ÓÊÕ»ú
 269   2                      switch(myTxRxData[2])   //½âÎöÖ¸Áî
 270   2                      {
 271   3                              case ComMode_2:         //ËµÃ÷ÔÚ30mÄÚ£¬Õı³££¬²»ÓÃ±¨¾¯
 272   3                              {
 273   4                                      TestFlag=0;             //Çå³¬Ê±±êÖ¾
 274   4                                      alarmCount2=0;  //Çå±¨¾¯¼ÆÊıÆ÷
 275   4                                      alarmFlag2=0;   //Çå±¨¾¯±êÖ¾
 276   4                                      alarmCount3=0;  //Çå±¨¾¯¼ÆÊıÆ÷
 277   4                                      alarmFlag3=0;   //Çå±¨¾¯±êÖ¾
 278   4                                      Moto=0;//¿ªÕğ¶¯
 279   4                                      Delay(10);
 280   4                                      Moto=1;
 281   4                              }
 282   3                              break;
 283   3                              
 284   3                              case ComMode_3:         //½Óµ½±àÂë3ĞÅºÅ£¬¿ªÊ¼±¨¾¯
 285   3                              {
 286   4                                      TestFlag=0;             //Çå³¬Ê±±êÖ¾                            
 287   4                                      alarmFlag3=1;
 288   4                                      alarmCount2=0;  //Çå±¨¾¯¼ÆÊıÆ÷
 289   4                                      alarmFlag2=0;   //Çå±¨¾¯±êÖ¾                    
 290   4                              }
 291   3                              break;
 292   3                      }
 293   2              }
 294   1      //      }
 295   1      }
 296          
 297          void time0() interrupt 1                //×÷ÎªÕû¸öÏµÍ³×Ô¼ºµÄÊ±ÖÓ
 298          {
 299   1              TH0=timer0H;                            //ÖØ×°ÔØ
 300   1              TL0=timer0L;
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 6   

 301   1      
 302   1              time0Count_3++;
 303   1      
 304   1              if(time0Count_3>=60)            //´®¿ÚÃ¿3S·¢ËÍÒ»´ÎµÄÊı¾İµÄÊ±¼ä±êÖ¾
 305   1              {
 306   2                      if(commuFlag==1)                //ËµÃ÷¿ªÆôÁËÍ¨ĞÅ
 307   2                      {
 308   3                              receive_en=0;
 309   3                              ComMode_1_Data();       //·¢ËÍÄ£Ê½1ĞÅºÅ
 310   3                              receive_en=1;           //´ò¿ª½ÓÊÕ»ú
 311   3                              TestFlag++;
 312   3                              if(TestFlag==6)         //Á¬ĞøÊı´ÎÃ»ÓĞÊÕµ½±àÂë2£¬Ôò±íÊ¾Ö÷»ú¶ªÊ§
 313   3                              {
 314   4                                      alarmFlag2=1;
 315   4                                      //¼ÓÈëÏàÓ¦´¦Àí´úÂë      
 316   4                              }
 317   3                      }
 318   2      
 319   2                      Check=GetADCResult(6);  //Ã¿¸ô3s×öÒ»´ÎµçÁ¿¼ì²â
 320   2                      time0Count_3=0;                 //3sµÄÖØĞÂ¼ÆÊı
 321   2              }
 322   1      }
 323          
 324          void ComMode_1_Data()                   //·¢ËÍ±àÂë1
 325          {
 326   1              unsigned char i,n;
 327   1      
 328   1              ModeControl_1=0;                        //´ó¹¦ÂÊ·¢ÉäÄ£Ê½
 329   1              tran_en=1;
 330   1              myTxRxData[0]=CmdHead;
 331   1              myTxRxData[1]=MyAddress;
 332   1              myTxRxData[2]=ComMode_1;
 333   1              myTxRxData[3]=0x00;
 334   1              myTxRxData[4]=0x00;
 335   1              myTxRxData[5]=0x00;
 336   1              myTxRxData[6]=0x00;
 337   1      
 338   1              initsignal();
 339   1              for(i=0;i<7;i++)
 340   1              {
 341   2                      for(n=0;n<8;n++)
 342   2                      {
 343   3                              if((myTxRxData[i]&0x80)==0x80)          //Îª1
 344   3                              {
 345   4                                      P10=0;
 346   4                                      Delay3(120);            //ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 347   4                              }
 348   3                              else//Îª0µÄÇé¿ö
 349   3                              {
 350   4                                      P10=0;
 351   4                                      Delay3(80);                     //ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 352   4                              }
 353   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 354   3                              myTxRxData[i]<<=1;
 355   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 356   3                      }
 357   2              }
 358   1              tran_en=0;
 359   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.01   NEWSLAVE                                                              07/23/2013 16:33:42 PAGE 7   

   CODE SIZE        =    797    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     50       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
