C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE NEWSLAVE
OBJECT MODULE PLACED IN .\out\newSlave.obj
COMPILER INVOKED BY: E:\Program Files (x86)\keil\C51\BIN\C51.EXE newSlave.c BROWSE DEBUG OBJECTEXTEND PRINT(.\listing\ne
                    -wSlave.lst) OBJECT(.\out\newSlave.obj)

line level    source

   1          
   2          
   3          #include"N79E81x.h"
   4          #include<intrins.h>
   5          #include"AD.h"
   6          #include"UART.h"
   7          #include"T0.h"
   8          #include"voice.h"
   9          #include"pwm.h"
  10          #include"T1.h"
  11          
  12          //¶¨ÒåÍ¨ÐÅÃüÁî
  13          
  14          #define CmdStart 0x00 //¿ª»úÃüÁî
  15          #define CmdStop 0x01  //¹Ø»úÃüÁî
  16          
  17          #define ComMode_1 0xc1 //Í¨ÐÅÄ£Ê½1 
  18          #define ComMode_2 0xc2 //Í¨ÐÅÄ£Ê½2
  19          #define ComMode_3 0xc3 //Í¨ÐÅÄ£Ê½3
  20          #define ComMode_4 0xc4 //Ì§ÆðÖ¸Áî
  21          #define ComMode_5 0xc5 //µ¹µØÖ¸Áî
  22          
  23          #define Succeed 0xce  //Í¨ÐÅ³É¹¦
  24          #define Wrong 0xff    //Í¨ÐÅÊ§°Ü
  25          
  26          #define CmdHead 0xc8
  27          #define CmdHead1 0x33 //Êý¾ÝÖ¡µÄÊ×²¿1, 00110011,11
  28          #define CmdHead2 0xcc //Êý¾ÝÖ¡µÄÊ×²¿2,11001100,00
  29          #define CmdHead3 0x3c //Êý¾ÝÖ¡µÄÊ×²¿3,11000011,01
  30          #define CmdHead4 0xcc //Êý¾ÝÖ¡µÄÊ×²¿4,11001100,00
  31          
  32          #define MyAddress 0xe0
  33          #define MyAddress1 0x33 //±¾»úµØÖ·1, 00110011,11
  34          #define MyAddress2 0x3c //±¾»úµØÖ·2, 11000011,01
  35          #define MyAddress3 0xcc //±¾»úµØÖ·3,11001100,00
  36          #define MyAddress4 0xcc //±¾»úµØÖ·4,11001100,00
  37          
  38          //ÈýÂ·Ñ­»·
  39          sbit onePin=P1^6;
  40          sbit twoPin=P1^7;
  41          sbit threePin=P0^0;
  42          
  43          //¸½»úµÄ·¢Éä²¿·ÖµÄ¿ØÖÆ¶Ë¿Ú
  44          //sbit PWMout=P3^5;//·¢Éä»úµÄ·½²¨Êä³ö¿Ú£¬ÏÖÔÚÊ¹ÓÃPWMÍâÉèÁË
  45          sbit ModeControl_1=P2^6;        //·¢Éä»úÄ£Ê½¿ØÖÆ,0Îª´ó¹¦ÂÊ£¬1ÎªÐ¡¹¦ÂÊ
  46          
  47          //½ÓÊÕ»ú¿ØÖÆ
  48          sbit SwitchControl=P1^3;        //1¹Ø±Õ½ÓÊÕ»ú£¬0¿ªÆô½ÓÊÕ»ú
  49          
  50          //¿ª¹Ø°´¼ü
  51          sbit Turn=P0^3; 
  52          
  53          //Ä£Ê½Ñ¡Ôñ°´¼ü
  54          sbit ModeChange=P0^4;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 2   

  55          
  56          //Âí´ï¿ØÖÆ¶Ë
  57          sbit Moto=P2^4;
  58          
  59          //µç³Ø¿ØÖÆ      ADµÄ1ºÅÍ¨µÀÎªµç³ØµÄµçÁ¿¼ì²â¶Ë
  60          sbit BatteryControl=P1^2;       //¿ØÖÆµç³ØÊÇ·ñ³äµçµÄ¿ª¹Ø£¬0Îª³äµç£¬1Îª²»³äµç
  61          
  62          //¿ª»ú×´Ì¬±ê¼ÇÎ»
  63          bit TurnFlag=0; //0Îª¹Ø»ú×´Ì¬£¬1Îª¿ª»ú×´Ì¬
  64          
  65          //Ä£Ê½Ñ¡ÔñÎ»£¬0ÔòÓÃÄ£Ê½1,1ÔòÓÃÄ£Ê½2
  66          bit ModeFlag=0;
  67          
  68          bit receiveFlag=0;      //½ÓÊÕµ½Êý¾Ý±êÖ¾
  69          bit commuFlag=0;        //¿ªÆôÍ¨ÐÅ±êÖ¾£¬1±íÊ¾¿ªÊ¼Í¨ÐÅ£¬0±íÊ¾Ã»ÓÐÍ¨ÐÅ
  70          
  71          bit alarmFlag2=0;       //±àÂë2±¨¾¯±êÖ¾
  72          bit alarmFlag3=0;       //±àÂë3±¨¾¯±êÖ¾
  73          bit alarmFlag4=0;       //Ì§Æð±¨¾¯±êÖ¾
  74          bit alarmFlag5=0;       //µ¹µØ±¨¾¯±êÖ¾
  75          unsigned char alarmCount2=0;//±¨¾¯2Ñ­»·´ÎÊý
  76          unsigned char alarmCount3=0;//±¨¾¯3Ñ­»·´ÎÊý
  77          unsigned char alarmCount4=0;//Ì§Æð±¨¾¯Ñ­»·´ÎÊý
  78          unsigned char alarmCount5=0;//µ¹µØ±¨¾¯Ñ­»·´ÎÊý
  79          
  80          bit threeFlag=0;        //ÈýÂ·Ñ­»·¿ª¹Ø±êÖ¾
  81          
  82          unsigned char voiceFlag=0;      //ÉùÒôÑ­»·¿ª¹Ø 
  83          
  84          unsigned char dataFirst=0;      //ÓÃÓÚ´æ´¢ÉÏ´Î±àÂëÀàÐÍ
  85          
  86          unsigned char count=0;  //´®¿Ú½ÓÊÕ²¿·ÖµÄ¼ÆÊýÆ÷
  87          
  88          unsigned int time0Count_3=0;    //¶¨Ê±Æ÷T0µÄ¼ÆÊý
  89          
  90          unsigned int lastAddr=0;        //ÉÏÒ»´Î½ÓÊÕµ½µÄ±àÂëµÄµØÖ·
  91          unsigned char TestFlag=0;       //1¡¢2¡¢3·Ö±ðÎªÃ¿1SºóµÄ¼ÆÊý£¬ÔÚ´®¿ÚµÄ³É¹¦Ö¸ÁîÀï»áÖ´ÐÐ½«È¥¹éÁãµÄ²Ù×÷
  92                                                  //Èç¹ûÁ¬Ðø3´Î¶¼Ã»ÓÐ¹éÁã£¬ÔòËµÃ÷²»ÔÚ³¡ÁË
  93          
  94          //×÷Îª½ÓÊÕºÍ·¢ËÍµÄ»º´æÇø
  95          unsigned char TxRxBuf[28]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
             -,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  96          //Ò»¸öÍ·×Ö½Ú£¬Ò»¸öµØÖ·×Ö½Ú£¬Ò»¸öÃüÁî×Ö½Ú£¬Á½¸ö±àÂëµØÖ·×Ö½Ú£¬Á½¸ö±àÂë
  97          unsigned char myTxRxData[7]={0x00,0x00,0x00,0x00,0x00,0x00,0x00};//´¦ÀíÍêºóµÄÍ¨ÐÅÊý¾ÝµÄ»º³åÇø
  98           
  99          //´®ÐÐÊý¾Ý¶¨Òå
 100          unsigned char DataBetween=0;//×÷Îª½ÓÊÕÊý¾ÝµÄÖÐ¼ä±äÁ¿
 101          unsigned char RecData=0;//½ÓÊÕµ½µÄÊý¾Ý
 102          unsigned char DataTime=0;//×÷Îª½ÓÊÕµÄÊý¾ÝµÄÒÆÎ»´ÎÊý¼ÆÊý
 103          bit ComFlag=1;  //¼ì²âÉÏÌøÑØºÍÏÂÌøÑØµÄ±êÊ¶
 104          unsigned char T1highcount=0;       //¶¨Ê±Æ÷T1ÔÚÃ»ÓÐÐÅºÅµ½À´µÄÊ±ºò£¬¶Ô¸ßµçÆ½¼ÆÊý£¬Ò»µ©³¬¹ýÄ³¸öÖµ£¬Ôò½«Datatime
             -Çå0
 105          
 106          unsigned int Check=0;   //×÷ÎªAD¼ì²âÖµ£¬¼ì²âµç³ØµçÁ¿
 107          
 108          //¹¦·Å¿ª¹Ø¿ØÖÆ£¬1Îª´ò¿ª¹¦·Å£¬0Îª¹Ø±Õ¹¦·Å
 109          sbit PAshutdown=P1^4;
 110          
 111          //¶¨ÒåÒ»¸ö¼ÆÊý£¬À´±íÊ¾ÐÅºÅ½ÓÊÕºó£¬¶à³¤Ê±¼äÊ¹½ÓÊÕ»ú´ò¿ª£¬¼´¿ØÖÆSwitchControlµÄ¸ßµçÆ½Ê±¼ä¡£
 112          unsigned int SwitchControlcount=0;
 113          
 114          //¶¨ÒåµçÑ¹±¨¾¯±êÖ¾Î»
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 3   

 115          unsigned char powerflag=1;
 116          
 117          //ÓÃÀ´¿ØÖÆËùÓÐ±¨¾¯µÄ×Ü¿ª¹Ø
 118          //unsigned char alarmflagall=0; 
 119          
 120          //º¯ÊýÉùÃ÷
 121          //void codeData(unsigned char *doData,unsigned char len);               //±àÂë ,µçÆ½1±äÎª0011£¬µçÆ½0±äÎª1100
 122          //void transCode(unsigned char *doData,unsigned char len);//½âÂë£¬½«½ÓÊÕµ½µÃÊý¾Ý»¹Ô­
 123          void ComMode_1_Data(void);//·¢ËÍ±ßÂë1
 124          
 125          //¿ª»úº¯Êý
 126          void StartAll(void);
 127          //¹Ø»úº¯Êý
 128          void StopAll(void);
 129          
 130          //t=1Ê±£¬ÑÓ³Ù100us×óÓÒ
 131          void Delay3(unsigned int t)
 132          {
 133   1              unsigned int i,j;
 134   1              for(i=0;i<t;i++)                
 135   1              for(j=0;j<23;j++);
 136   1      }
 137          
 138          //init signal£¬·¢ËÍ±àÂëÐÅºÅÇ°µÄÆðÊ¼ÐÅºÅ£¬ÓÃÓÚ½«½ÓÊÕ»úµÄ×Ô¶¯ÔöÒæ´ò¿ª
 139          void initsignal()
 140          {
 141   1              unsigned char k,k1;
 142   1              unsigned char mystartbuffer=0xaa;
 143   1              for(k1=0;k1<3;k1++)
 144   1              {
 145   2                      for(k=0;k<8;k++)
 146   2                      {
 147   3                              if((mystartbuffer&0x80)==0x80)//Îª1
 148   3                              {
 149   4                                      P10=0;
 150   4                                      Delay3(80);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 151   4                              }
 152   3                              else//Îª0µÄÇé¿ö
 153   3                              {
 154   4                                      P10=0;
 155   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 156   4                              }
 157   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 158   3                              mystartbuffer<<=1;
 159   3                              Delay3(150);//ÑÓÊ±Òª´óÓÚ2ms
 160   3                      }
 161   2                      mystartbuffer=0xaa;
 162   2                      Delay3(150);
 163   2              }
 164   1              P10=1;
 165   1              Delay3(80);
 166   1      }
 167          
 168          void main(void)
 169          {
 170   1              noVoice();                       //¿ª»ú²»·¢ÉùÒô
 171   1      
 172   1      //      InitUART();
 173   1              InitT0();                        //³õÊ¼»¯¶¨Ê±Æ÷0ºÍ¶¨Ê±Æ÷1
 174   1              InitT1();
 175   1      //      TI=0;
 176   1      //      RI=0;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 4   

 177   1      
 178   1      //      SwitchControl=0;         //½ÓÊÕ»úµÄ¿ØÖÆ¶ËÎª¸ßµçÆ½£¬¼´¹Ø±Õ½ÓÊÕ»ú 
 179   1      
 180   1              Turn=1;                         //¿ª»ú¼üÖÃ1£¬ºóÃæ¼ì²âÊÇ·ñÎª0
 181   1              ModeChange=1;           //P04ÖÃ1£¬ºóÃæ¼ì²âÊÇ·ñÎª0£¬À´¸Ä±äÄ£Ê½£¬³Ë³µÄ£Ê½ºÍÆÕÍ¨Ä£Ê½
 182   1      
 183   1              BatteryControl=0;       //¸½»úÉÏµçµÄÊ±ºòÖÃ0£¬¼´¿ÉÒÔ³äµç£¬µç³ØÔÚÃ»ÓÐ³äÂúµÄÇé¿öÏÂÎªµÍµçÆ½
 184   1      
 185   1              Moto=1;                         //¹Ø±ÕÂí´ï
 186   1              SwitchControl=0;         //¿ªÆð½ÓÊÕ»úµÄ¿ØÖÆ¶ËÎª¸ßµçÆ½
 187   1      
 188   1      //      ES=1;
 189   1              ET0=1;                           //Ê¹ÄÜ¶¨Ê±Æ÷0ºÍ1µÄÖÐ¶Ï
 190   1              ET1=1;
 191   1      //      PS=1;
 192   1              PT1=1;                           //ÉèÖÃ¶¨Ê±Æ÷1Îª½Ï¸ßÓÅÏÈ¼¶
 193   1              EA=1;                            //ËùÓÐÖÐ¶ÏÊ¹ÄÜ
 194   1      
 195   1              myPwm();        //¿ª·¢Éä»ú
 196   1      
 197   1      //      P1M1=0x02;
 198   1      //      P1M2=0x00;
 199   1              P10=1;
 200   1      //      P11=1;
 201   1      
 202   1              PAshutdown=0;             //¿ª»úÊ±£¬½«¹¦·Å¹Ø±Õ
 203   1              Check=GetADCResult(6);//µç³ØµçÁ¿¼ì²â
 204   1      
 205   1              while(1)
 206   1              {
 207   2                      if(Turn==0)
 208   2                      {
 209   3                              Delay(30);
 210   3                              if(Turn==0)
 211   3                              {
 212   4      //                              while(Turn==0);
 213   4                                      if(TurnFlag==0)          //ËµÃ÷ÊÇ¹Ø»ú×´Ì¬,Ôò¿ª»ú
 214   4                                      {
 215   5      //                                      SwitchControl=0;         //¿ªÆð½ÓÊÕ»úµÄ¿ØÖÆ¶ËÎª¸ßµçÆ½ 
 216   5      
 217   5                                              PAshutdown=1;
 218   5                                              SC_Speech(4);
 219   5                                              Delay(200);
 220   5                                              PAshutdown=0;
 221   5      
 222   5                                              ModeControl_1=0;  //·¢Éä»úÄ£Ê½¿ØÖÆ¶Ë,¿ª»úÊ±ÉèÎª1.5MÄ£Ê½,¿ªÆô·¢Éä»ú                                      
 223   5                              
 224   5                                              if(Check>=0x35a)//ÉèÖÃ±È½ÏµçÑ¹£¬´Ë´¦Îª3.3V
 225   5                                              {
 226   6                                                      PAshutdown=1;
 227   6                                                      SC_Speech(6);//µçÑ¹³ä×ãÌáÊ¾
 228   6                                                      Delay(200);
 229   6                                                      PAshutdown=0;
 230   6      //                                              poweroverflag=1;                           
 231   6                                              }
 232   5                                              else
 233   5                                              {
 234   6                                                      PAshutdown=1;
 235   6                                                      SC_Speech(7);//µçÑ¹²»³ä×ãÌáÊ¾
 236   6                                                      Delay(200);
 237   6                                                      PAshutdown=0;
 238   6      //                                              poweroverflag=0;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 5   

 239   6                                              }
 240   5      
 241   5                                              StartAll();//¿ª»ú¸øÖ÷»ú·¢ËÍ¿ª»úÖ¸Áî     
 242   5                                              commuFlag=1;//¿ªÆôÍ¨ÐÅ
 243   5                                              TurnFlag=1;
 244   5                                      }
 245   4                                      else
 246   4                                      {        
 247   5      //                                      SwitchControl=0;//¹Ø±Õ½ÓÊÕ»ú¿ØÖÆ¶ËÎªµÍµçÆ½
 248   5                                              
 249   5                                              PAshutdown=1;
 250   5                                              SC_Speech(5);
 251   5                                              Delay(120);
 252   5                                              PAshutdown=0;
 253   5      
 254   5                                              Moto=1;//Í£Ö¹Âí´ïÕð¶¯
 255   5      
 256   5      //                                      Check=GetADCResult(6);//µç³ØµçÁ¿¼ì²â
 257   5                                              if(Check>=0x35a)//ÉèÖÃ±È½ÏµçÑ¹£¬´Ë´¦Îª4V
 258   5                                              {
 259   6                                                      PAshutdown=1;
 260   6                                                      SC_Speech(6);//µçÑ¹³ä×ãÌáÊ¾
 261   6                                                      Delay(120);     
 262   6                                                      PAshutdown=0;
 263   6      //                                              poweroverflag=1;
 264   6                                              }
 265   5                                              else
 266   5                                              {
 267   6                                                      PAshutdown=1;
 268   6                                                      SC_Speech(7);//µçÑ¹²»³ä×ãÌáÊ¾
 269   6                                                      Delay(120);
 270   6                                                      PAshutdown=0;
 271   6      //                                              poweroverflag=0;
 272   6                                              }
 273   5                                              commuFlag=0;//¹Ø±ÕÍ¨ÐÅ
 274   5      
 275   5                                              StopAll();
 276   5                                              Delay3(150);
 277   5                                              StopAll();
 278   5                                              Delay3(150);
 279   5                                              StopAll();
 280   5                                              Delay3(150);
 281   5      
 282   5                                              TurnFlag=0;
 283   5                                              alarmCount2=0;//Çå±¨¾¯¼ÆÊýÆ÷
 284   5                                              alarmFlag2=0;//Çå±¨¾¯±êÖ¾
 285   5                                              alarmCount3=0;//Çå±¨¾¯¼ÆÊýÆ÷
 286   5                                              alarmFlag3=0;//Çå±¨¾¯±êÖ¾
 287   5                                      }
 288   4                              }
 289   3                      }
 290   2                      if(ModeChange==0)
 291   2                      {
 292   3                              Delay(20);
 293   3                              if(ModeChange==0)
 294   3                              {
 295   4      //                              while(ModeChange==0);
 296   4                                      if(ModeFlag==0&&TurnFlag==1)//¿ª»ú×´Ì¬¿ÉÒÔµ÷Ä£Ê½
 297   4                                      {
 298   5                                              ModeControl_1=1;//ÇÐ»»·¢Éä»úÄ£Ê½
 299   5                                              ModeFlag=1;
 300   5                              
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 6   

 301   5                                              PAshutdown=1;
 302   5                                              SC_Speech(2);
 303   5                                              Delay(140);
 304   5                                              PAshutdown=0;
 305   5                                      }
 306   4                                      else if(ModeFlag==1&&TurnFlag==1)
 307   4                                      {
 308   5                                              ModeControl_1=0; //ÇÐ»»·¢Éä»úÄ£Ê½
 309   5                                              ModeFlag=0;
 310   5                              
 311   5                                              PAshutdown=1;
 312   5                                              SC_Speech(3);
 313   5                                              Delay(140);
 314   5                                              PAshutdown=0;
 315   5                                      }
 316   4                              }
 317   3                      }
 318   2      
 319   2                      if((alarmFlag2==1)&&(alarmCount2<1))//±àÂë2¿ªÊ¼ÏàÓ¦µÄ±¨¾¯
 320   2                      {
 321   3                              alarmCount2++;
 322   3      
 323   3                              PAshutdown=1;
 324   3                              SC_Speech(1);
 325   3                              Delay(160);
 326   3                              PAshutdown=0;                   
 327   3      
 328   3                              Moto=0; //¿ªÕð¶¯
 329   3                              Delay(10);
 330   3                              Moto=1;
 331   3                              
 332   3                              PAshutdown=1;
 333   3                              SC_Speech(1);
 334   3                              Delay(160);
 335   3                              PAshutdown=0;
 336   3      
 337   3                              Moto=0;//¿ªÕð¶¯
 338   3                              Delay(10);
 339   3                              Moto=1;
 340   3                      }
 341   2                      
 342   2      //              if(alarmCount2>=1)  //µ÷½ÚÓïÒôµÄ¶ÎÊý
 343   2      //              {
 344   2      //                      alarmCount2=0;//Çå±¨¾¯¼ÆÊýÆ÷
 345   2      //                      alarmFlag2=0;//Çå±¨¾¯±êÖ¾
 346   2      //              }
 347   2      
 348   2                      if((alarmFlag3==1)&&(alarmCount3<1))//±àÂë3¿ªÊ¼ÏàÓ¦µÄ±¨¾¯
 349   2                      {
 350   3                              alarmCount3++;
 351   3                              
 352   3                              PAshutdown=1;
 353   3                              SC_Speech(10);
 354   3                              Delay(150);
 355   3                              Moto=0;//¿ªÕð¶¯
 356   3                              Delay(20);
 357   3                              Moto=1;
 358   3              
 359   3                              SC_Speech(10);
 360   3                              Delay(150);
 361   3                              Moto=0;//¿ªÕð¶¯
 362   3                              Delay(20);
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 7   

 363   3                              Moto=1;
 364   3                              PAshutdown=0;
 365   3                      }
 366   2      
 367   2      //              if(alarmCount3>=1) //µ÷½ÚÓïÒôµÄ¶ÎÊý        
 368   2      //              {
 369   2      //                      alarmCount3=0;//Çå±¨¾¯¼ÆÊýÆ÷
 370   2      //                      alarmFlag3=0;//Çå±¨¾¯±êÖ¾
 371   2      //              }
 372   2      
 373   2                      if(Check>=0x377) //±íÊ¾µç³Ø³ä°üÁË
 374   2                      {
 375   3                              BatteryControl=1;//¿ªÂ©Ä£Ê½£¬ÕâÑùÎª¸ß×èÌ¬       
 376   3                      }
 377   2                      else
 378   2                      {
 379   3                              BatteryControl=0;//µç³ØÔÚÃ»ÓÐ³äÂúµÄÇé¿öÏÂÎªµÍµçÆ½
 380   3                      }
 381   2      
 382   2                      if(TurnFlag==1)
 383   2                      {
 384   3                              if((powerflag==1)&&(Check<=0x35a))
 385   3                              {
 386   4                                      powerflag=0;
 387   4                                      PAshutdown=1;
 388   4                                      SC_Speech(7);   //µçÑ¹²»³ä×ãÌáÊ¾
 389   4                                      Delay(120);
 390   4                                      PAshutdown=0;
 391   4                              }
 392   3                              else if((powerflag==0)&&(Check>=0x377))
 393   3                              {
 394   4                                      powerflag=1;
 395   4                                      PAshutdown=1;
 396   4                                      SC_Speech(6);   //µçÑ¹³ä×ãÌáÊ¾
 397   4                                      Delay(120);
 398   4                                      PAshutdown=0;
 399   4                              }
 400   3                      }
 401   2      
 402   2      //              if(SwitchControlcount==18000)
 403   2      //              {
 404   2      //                      SwitchControl=0;
 405   2      //                      SwitchControlcount=0;   
 406   2      //              }
 407   2              }
 408   1      }
 409          
 410          void timeT1() interrupt 3 //¶¨Ê±Æ÷1ÖÐ¶Ï½ÓÊÕÊý¾Ý
 411          {
 412   1      //      unsigned int newAddr=0;
 413   1              TH1=timer1H;//ÖØ×°ÔØ
 414   1              TL1=timer1L;
 415   1         
 416   1      //      if(SwitchControl==1)
 417   1      //      {
 418   1      //              SwitchControlcount++;
 419   1      //      }
 420   1      //      else
 421   1      //      {
 422   1              if(P11==0)//Õý³£Çé¿öÎª¸ßµçÆ½,ÓÐµÍµçÆ½ËµÃ÷ÓÐÐÅºÅ
 423   1              {
 424   2                      DataBetween++;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 8   

 425   2                      ComFlag=0;
 426   2                      if(DataBetween==150)//µÍµçÆ½³ÖÐøµÄ×î´óÊ±¼ä      
 427   2                      {
 428   3                              DataBetween=0;
 429   3                      }
 430   2              }
 431   1              else//Îª¸ßµçÆ½ÁË
 432   1              {
 433   2                      if(ComFlag==0)//ËµÃ÷ÓÐÒ»¸öµÍµçÆ½
 434   2                      {
 435   3                              ComFlag=1;
 436   3      //                              RecData<<=1;
 437   3      
 438   3                              if((DataBetween>60)&&(DataBetween<=100))        //µÍµçÆ½³ÖÐøµÄÊ±¼äÐ¡ÓÚ10ms£¬ÔòÎª0
 439   3                              {
 440   4                                      RecData<<=1;
 441   4                                      RecData &= 0xfe;
 442   4                                      DataTime++;
 443   4                                      T1highcount=0;
 444   4                              }
 445   3                              else if((DataBetween>100))//µÍµçÆ½³ÖÐøµÄÊ±¼ä´óÓÚ4.5ms£¬ÔòÎª1
 446   3                              {
 447   4                                      RecData<<=1;
 448   4                                      RecData |= 0x01;
 449   4                                      DataTime++;
 450   4                                      T1highcount=0;
 451   4                              }
 452   3                              else
 453   3                              {
 454   4                                      T1highcount++;  
 455   4                              }
 456   3      
 457   3                              DataBetween=0;
 458   3      //                              DataTime++;
 459   3                      }
 460   2                      else
 461   2                      {
 462   3                              T1highcount++;
 463   3                              if(T1highcount>=120)
 464   3                              {
 465   4                                      DataTime=0;
 466   4                                      ComFlag=1;
 467   4                                      count=0;
 468   4                              }               
 469   3                      }
 470   2              }
 471   1      
 472   1              if(DataTime==8)//ËµÃ÷Ò»¸ö×Ö½ÚµÄÊý¾ÝÒÑ¾­½ÓÊÜÍêÈ«
 473   1              {
 474   2                      DataTime=0;
 475   2                      myTxRxData[count]=RecData;
 476   2                      if(count==0&&myTxRxData[0]==CmdHead)
 477   2                      {
 478   3                              count=1;
 479   3                      }
 480   2                      else if(count==1&&myTxRxData[1]==MyAddress)
 481   2                      {
 482   3                              count=2;
 483   3                      }
 484   2                      else if(count>=2&&count<=5)
 485   2                      {
 486   3                              count++;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 9   

 487   3                      }
 488   2                      else if(count==6)
 489   2                      {
 490   3                              receiveFlag=1;
 491   3                              count=0;
 492   3                      }
 493   2                      else 
 494   2                      {
 495   3                              count=0;
 496   3                      }
 497   2              }
 498   1      
 499   1              if(receiveFlag==1)      //ËµÃ÷½ÓÊÕµ½ÁËÊý¾Ý£¬¿ªÊ¼´¦Àí
 500   1              {
 501   2                      receiveFlag=0;  //Çå½ÓÊÕ±êÖ¾
 502   2                      SwitchControl=1;
 503   2      
 504   2      //              transCode(TxRxBuf,0x1c);//½«½ÓÊÕµ½µÃÊý¾Ý½âÂë
 505   2       
 506   2                      switch(myTxRxData[2])//½âÎöÖ¸Áî
 507   2                      {
 508   3      /*
 509   3                              case ComMode_1://½ÓÊÕµ½µÄÊÇÖ÷»ú·¢ËÍ¹ýÀ´µÄ±àÂë1µÄÐÅºÅ£¬ËµÃ÷Ö÷»úÔÚ3MÄÚ£¬ÊÇÕý³£µÄ
 510   3                              {       
 511   3      //                                      newAddr=(newAddr|myTxRxData[4])<<8;//¸ß°ËÎ»
 512   3      //                                      newAddr=newAddr+myTxRxData[3];             //µÍ°ËÎ»
 513   3      //                                      if(PassWord[newAddr]==myTxRxData[5]&&PassWord[newAddr+1]==myTxRxData[6])//ÃÜÂë±íÊÇ·ñ¹ö¶¯ÁËÒ»¸öÈ»ºó¶
             -ÔµÄ×¡
 514   3      //                                      {
 515   3      //                                              if(newAddr>=999)
 516   3      //                                              {
 517   3      //                                                      lastAddr=0;
 518   3                                      TestFlag=0;
 519   3      
 520   3      //                                      alarmCount2=0;//Çå±¨¾¯¼ÆÊýÆ÷
 521   3      //                                      alarmFlag2=0;//Çå±¨¾¯±êÖ¾
 522   3      //                                      alarmCount3=0;//Çå±¨¾¯¼ÆÊýÆ÷
 523   3      //                                      alarmFlag3=0;//Çå±¨¾¯±êÖ¾
 524   3      //                              SwitchControl=1;
 525   3      //                                              }
 526   3      //                                              else
 527   3      //                                              {
 528   3      //                                                       lastAddr+=1;
 529   3      //                                                       TestFlag=0;//Õý³£Çé¿ö£¬Çå³¬Ê±±êÖ¾
 530   3      //                                              }
 531   3      //                              dataFirst=ComMode_1;
 532   3      //                              if(ModeFlag==2||ModeFlag==3)
 533   3      //                              {
 534   3      //                                      SC_Speech(0x01);        //»Ö¸´ÁËÕý³££¬×öÏàÓ¦¸´Î»¶¯×÷
 535   3      //                              }
 536   3                              }
 537   3                              break;
 538   3      */                              
 539   3                              case ComMode_2://ËµÃ÷ÔÚ30mÄÚ£¬ÒÑ²»Õý³£
 540   3                              {
 541   4                                      TestFlag=0;//Çå³¬Ê±±êÖ¾
 542   4      //                                      alarmFlag2=1;
 543   4                                      alarmCount2=0;//Çå±¨¾¯¼ÆÊýÆ÷
 544   4                                      alarmFlag2=0;//Çå±¨¾¯±êÖ¾
 545   4                                      alarmCount3=0;//Çå±¨¾¯¼ÆÊýÆ÷
 546   4                                      alarmFlag3=0;//Çå±¨¾¯±êÖ¾
 547   4                              }
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 10  

 548   3                              break;
 549   3                              
 550   3                              case ComMode_3:
 551   3                              {
 552   4      //                                      TestFlag=0;//Çå³¬Ê±±êÖ¾                         
 553   4                                      alarmFlag3=1;
 554   4                                      alarmCount2=3;                  
 555   4                              }
 556   3                              break;
 557   3                              
 558   3                              case ComMode_4://Áô×÷Ì§ÆðÐÅºÅÊ¹ÓÃ
 559   3                              {
 560   4                                      TestFlag=0;//Çå³¬Ê±±êÖ¾ 
 561   4                                      alarmFlag4=1;//Ì§Æð±¨¾¯
 562   4                              }
 563   3                              break;
 564   3      
 565   3                              case ComMode_5://Áô×÷µ¹µØÐÅºÅÊ¹ÓÃ
 566   3                              {
 567   4                                      TestFlag=0;//Çå³¬Ê±±êÖ¾
 568   4                                      alarmFlag5=1;   //µ¹µØ±¨¾¯
 569   4                              }
 570   3                              break;
 571   3                      }
 572   2              }
 573   1      //      }
 574   1      }
 575          
 576          void time0() interrupt 1        //×÷ÎªÕû¸öÏµÍ³×Ô¼ºµÄÊ±ÖÓ
 577          {
 578   1              TH0=timer0H;//ÖØ×°ÔØ
 579   1              TL0=timer0L;
 580   1      
 581   1              time0Count_3++;
 582   1      
 583   1              if(time0Count_3>=60)//´®¿ÚÃ¿1S·¢ËÍÒ»´ÎµÄÊý¾ÝµÄÊ±¼ä±êÖ¾
 584   1              {
 585   2      /*
 586   2                      if(onePin==0&&threeFlag==0)
 587   2                      {
 588   2                              onePin=1;
 589   2                              twoPin=0;
 590   2                              threePin=0;
 591   2                              threeFlag=1;
 592   2                      }
 593   2                      else if(twoPin==0&&onePin==1)
 594   2                      {
 595   2                              onePin=0;
 596   2                              twoPin=1;
 597   2                              threePin=0;
 598   2                      }
 599   2                      else if(threePin==0&&twoPin==1)
 600   2                      {
 601   2                              onePin=0;
 602   2                              twoPin=0;
 603   2                              threePin=1;
 604   2                              threeFlag=0;
 605   2                      }
 606   2      */
 607   2      
 608   2                      if(commuFlag==1)//ËµÃ÷¿ªÆôÁËÍ¨ÐÅ
 609   2                      {
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 11  

 610   3                              ComMode_1_Data();//·¢ËÍÄ£Ê½1ÐÅºÅ
 611   3      //                      SendData(0xbc);  //²âÊÔÊý¾Ý
 612   3                              
 613   3                              TestFlag++;
 614   3                              if(TestFlag>=6)//ËµÃ÷ÒÑ¾­³öÁË300MÁË¡£ÊÕ²»µ½ÈÎºÎÐÅºÅÁË£¬Òª×ö±¨¾¯
 615   3                              {
 616   4                                      TestFlag=7;
 617   4                                      alarmFlag2=1;
 618   4                                      //¼ÓÈëÏàÓ¦´¦Àí´úÂë      
 619   4                              }
 620   3                      }
 621   2      
 622   2                      Check=GetADCResult(6);//µç³ØµçÁ¿¼ì²â
 623   2                      time0Count_3=0;
 624   2              }
 625   1      }
 626          
 627          void StartAll() //·¢ËÍ¿ªÊ¼ÐÅºÅ
 628          {
 629   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 630   1      //      P0M2&=0xfd;
 631   1      //      ModeControl_1=0;//·¢Éä¹¦ÂÊÑ¡Ôñ£¬ÓÐ°´¼üÀ´È·¶¨                            
 632   1      //      myPwm();        //¿ª·¢Éä»ú
 633   1      
 634   1      /*
 635   1              SendData(0x55);
 636   1              SendData(0xf0);
 637   1              SendData(0xaa);
 638   1              SendData(0x0f);
 639   1      */
 640   1              unsigned char i,n;
 641   1      
 642   1              myTxRxData[0]=CmdHead;
 643   1              myTxRxData[1]=MyAddress;
 644   1              myTxRxData[2]=CmdStart;
 645   1              myTxRxData[3]=0x00;
 646   1              myTxRxData[4]=0x00;
 647   1              myTxRxData[5]=0x00;
 648   1              myTxRxData[6]=0x00;
 649   1      
 650   1              initsignal();
 651   1      
 652   1              for(i=0;i<7;i++)
 653   1              {
 654   2                      for(n=0;n<8;n++)
 655   2                      {
 656   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 657   3                              {
 658   4                                      P10=0;
 659   4                                      Delay3(110);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 660   4                              }
 661   3                              else//Îª0µÄÇé¿ö
 662   3                              {
 663   4                                      P10=0;
 664   4                                      Delay3(70);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 665   4                              }
 666   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 667   3                              myTxRxData[i]<<=1;
 668   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 669   3                      }
 670   2              }
 671   1      //      codeData(myTxRxData,7);
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 12  

 672   1      
 673   1      //      SendNByte(TxRxBuf,28);
 674   1      
 675   1      //      ²âÊÔ
 676   1      //      SendNByte(myTxRxData,7);
 677   1      
 678   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
 679   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 680   1      //      P0M2&=0xfd;
 681   1      }
 682          
 683          void StopAll() //·¢ËÍÍ£Ö¹ÐÅºÅ
 684          {
 685   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 686   1      //      P0M2&=0xfd;
 687   1      //ModeControl_1=0;//·¢Éä¹¦ÂÊÑ¡Ôñ£¬ÓÐ°´¼üÀ´È·¶¨                          
 688   1      //      myPwm();        //¿ª·¢Éä»ú
 689   1      /*
 690   1              SendData(0x55);
 691   1              SendData(0xf0);
 692   1              SendData(0xaa);
 693   1              SendData(0x0f);
 694   1      */
 695   1      
 696   1              unsigned char i,n;
 697   1      
 698   1              myTxRxData[0]=CmdHead;
 699   1              myTxRxData[1]=MyAddress;
 700   1              myTxRxData[2]=CmdStop;
 701   1              myTxRxData[3]=0x00;
 702   1              myTxRxData[4]=0x00;
 703   1              myTxRxData[5]=0x00;
 704   1              myTxRxData[6]=0x00;
 705   1      
 706   1              initsignal();
 707   1      
 708   1              for(i=0;i<7;i++)
 709   1              {
 710   2                      for(n=0;n<8;n++)
 711   2                      {
 712   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 713   3                              {
 714   4                                      P10=0;
 715   4                                      Delay3(110);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 716   4                              }
 717   3                              else//Îª0µÄÇé¿ö
 718   3                              {
 719   4                                      P10=0;
 720   4                                      Delay3(70);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 721   4                              }
 722   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 723   3                              myTxRxData[i]<<=1;
 724   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 725   3                      }
 726   2              }
 727   1      //      codeData(myTxRxData,7);
 728   1      //      SendNByte(TxRxBuf,28);
 729   1      //²âÊÔ
 730   1      //      SendNByte(myTxRxData,7);
 731   1      
 732   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
 733   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 13  

 734   1      //      P0M2&=0xfd;
 735   1      }
 736          
 737          void ComMode_1_Data()//·¢ËÍ±ßÂë1
 738          {
 739   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 740   1      //      P0M2&=0xfd;
 741   1              
 742   1                                              
 743   1      //      myPwm();        //¿ª·¢Éä»ú
 744   1      //      ModeTurn=0;
 745   1      /*
 746   1              SendData(0x55);
 747   1              SendData(0xf0);
 748   1              SendData(0xaa);
 749   1              SendData(0x0f);
 750   1      */
 751   1              unsigned char i,n;
 752   1      
 753   1              ModeControl_1=0;//30M·¢Éä¹¦ÂÊ
 754   1      
 755   1              myTxRxData[0]=CmdHead;
 756   1              myTxRxData[1]=MyAddress;
 757   1              myTxRxData[2]=ComMode_1;
 758   1              myTxRxData[3]=0x00;
 759   1              myTxRxData[4]=0x00;
 760   1              myTxRxData[5]=0x00;
 761   1              myTxRxData[6]=0x00;
 762   1      
 763   1              initsignal();
 764   1      
 765   1              for(i=0;i<7;i++)
 766   1              {
 767   2                      for(n=0;n<8;n++)
 768   2                      {
 769   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 770   3                              {
 771   4                                      P10=0;
 772   4                                      Delay3(110);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 773   4                              }
 774   3                              else//Îª0µÄÇé¿ö
 775   3                              {
 776   4                                      P10=0;
 777   4                                      Delay3(70);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 778   4                              }
 779   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 780   3                              myTxRxData[i]<<=1;
 781   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 782   3                      }
 783   2              }
 784   1      //      codeData(myTxRxData,7);
 785   1      //      SendNByte(TxRxBuf,28);
 786   1      //      ²âÊÔ
 787   1      //      SendNByte(myTxRxData,7);
 788   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
 789   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 790   1      //      P0M2&=0xfd;
 791   1      }
 792          
 793          
 794          /*
 795          void codeData(unsigned char *doData,unsigned char len)          //±àÂë ,µçÆ½1±äÎª0011£¬µçÆ½0±äÎª1100
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 14  

 796          {
 797                  unsigned char n,j,i=0;
 798                  for(n=0;n<len;n++)
 799                  {       
 800                          
 801                          for(j=0;j<8;j++)        
 802                          {
 803                                  if(j==0||j==1)
 804                                  {       
 805                                           TxRxBuf[i]<<=4;
 806                                          if((*doData&0x80)==0x80)
 807                                          {
 808                                                  TxRxBuf[i]|=0x03;       
 809                                          }
 810                                          else
 811                                          {
 812                                                  TxRxBuf[i]|=0x0c;
 813                                          }
 814                                          *doData<<=1;
 815                                  }
 816                                  else if(j==2||j==3)
 817                                  {
 818                                          TxRxBuf[i+1]<<=4;
 819                                          if((*doData&0x80)==0x80)
 820                                          {
 821                                                  TxRxBuf[i+1]|=0x03;     
 822                                          }
 823                                          else
 824                                          {
 825                                                  TxRxBuf[i+1]|=0x0c;
 826                                          }
 827                                          *doData<<=1;
 828                                  }
 829                                  else if(j==4||j==5)
 830                                  {
 831                                          TxRxBuf[i+2]<<=4;
 832                                          if((*doData&0x80)==0x80)
 833                                          {
 834                                                  TxRxBuf[i+2]|=0x03;             
 835                                          }
 836                                          else
 837                                          {
 838                                                  TxRxBuf[i+2]|=0x0c;
 839                                          }
 840                                          *doData<<=1;
 841                                  }
 842                                  else if(j==6||j==7)
 843                                  {
 844                                          TxRxBuf[i+3]<<=4;
 845                                          if((*doData&0x80)==0x80)
 846                                          {
 847                                                  TxRxBuf[i+3]|=0x03;                                             
 848                                          }
 849                                          else
 850                                          {
 851                                                  TxRxBuf[i+3]|=0x0c;                             
 852                                          }
 853                                          *doData<<=1;
 854                                  }
 855          
 856                          }
 857                          i+=4;
C51 COMPILER V9.00   NEWSLAVE                                                              05/13/2013 14:33:29 PAGE 15  

 858                          doData++;
 859                  }
 860          }
 861          */
 862          
 863          /*
 864          void transCode(unsigned char *doData,unsigned char len)//½âÂë£¬½«½ÓÊÕµ½µÃÊý¾Ý»¹Ô­
 865          {
 866                  unsigned char i,j;
 867                  for(i=0;i<len;i++)
 868                  {
 869                          for(j=0;j<2;j++)
 870                          {
 871                                  myTxRxData[i/4]<<=1;
 872          
 873                                  if((*doData&0x30)==0x30)//ËµÃ÷Îª1
 874                                  {
 875                                          myTxRxData[i/4]|=0x01;
 876                                  }
 877                                  else if((*doData&0xc0)==0xc0)  //ËµÃ÷Îª0
 878                                  {
 879                                          myTxRxData[i/4]&=0xfe;  
 880                                  }
 881          
 882                                  *doData<<=4;
 883                          }
 884                          doData++;
 885                  }
 886          }
 887          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1209    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     56       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     10    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
