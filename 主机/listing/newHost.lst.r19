C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE NEWHOST
OBJECT MODULE PLACED IN .\out\newHost.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE newHost.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\listing\newHost.lst) OBJE
                    -CT(.\out\newHost.obj)

line level    source

   1          
   2          #include"N79E81x.h"
   3          #include<intrins.h>
   4          #include"AD.h"
   5          #include"UART.h"
   6          #include"T0.h"
   7          #include"voice.h"
   8          #include"pwm.h"
   9          #include"T1.h"
  10          
  11          //¶¨ÒåÍ¨ĞÅÃüÁî
  12          
  13          #define CmdStart 0x00 //¿ª»úÃüÁî
  14          #define CmdStop 0x01  //¹Ø»úÃüÁî
  15          
  16          #define ComMode_1 0xc1 //Í¨ĞÅÄ£Ê½1 
  17          #define ComMode_2 0xc2 //Í¨ĞÅÄ£Ê½2
  18          #define ComMode_3 0xc3 //Í¨ĞÅÄ£Ê½3
  19          #define ComMode_4 0xc4 //Ì§ÆğÖ¸Áî
  20          #define ComMode_5 0xc5//µ¹µØÖ¸Áî
  21          
  22          #define Succeed 0xce  //Í¨ĞÅ³É¹¦
  23          #define Wrong 0xff    //Í¨ĞÅÊ§°Ü
  24          
  25          #define CmdHead 0xc8
  26          #define CmdHead1 0x33 //Êı¾İÖ¡µÄÊ×²¿1, 00110011,11
  27          #define CmdHead2 0xcc //Êı¾İÖ¡µÄÊ×²¿2,11001100,00
  28          #define CmdHead3 0x3c //Êı¾İÖ¡µÄÊ×²¿3,11000011,01
  29          #define CmdHead4 0xcc //Êı¾İÖ¡µÄÊ×²¿4,11001100,00
  30          
  31          #define MyAddress 0xe0
  32          #define MyAddress1 0x33 //±¾»úµØÖ·1, 00110011,11
  33          #define MyAddress2 0x3c //±¾»úµØÖ·2, 11000011,01
  34          #define MyAddress3 0xcc //±¾»úµØÖ·3,11001100,00
  35          #define MyAddress4 0xcc //±¾»úµØÖ·4,11001100,00
  36          
  37          //ÈıÂ·Ñ­»·
  38          //sbit onePin=P1^6;
  39          //sbit twoPin=P1^7;
  40          
  41          
  42          //Ö÷»úµÄ·¢Éä²¿·ÖµÄ¿ØÖÆ¶Ë¿Ú
  43          //sbit PWMout=P0^1;//·¢Éä»úµÄ·½²¨Êä³ö¿Ú£¬Ê¹ÓÃÍâÉèPWM
  44          sbit ModeControl_1=P2^6;//·¢Éä»úÄ£Ê½¿ØÖÆ,0ÁÁÎª30MÄ£Ê½£¬1ÃğÎª300MÄ£Ê½
  45          //sbit ModeTurn=P2^7;//·¢Éä»ú¿ª¹Ø£¬1ÁÁÎª¿ªÁË£¬0ÃğÎª¹ØÁË
  46          
  47          //½ÓÊÕ»ú¿ØÖÆ
  48          sbit SwitchControl=P1^3;//1ÓĞĞ§£¬0¹Ø±Õ
  49          
  50          //ÈıÖá´«¸ĞÆ÷
  51          sbit ReceWave=P0^7;//ÈıÖá´«¸ĞÆ÷ÊäÈë¶Ë
  52          sbit SensorControl=P2^5;//ÈıÖá´«¸ĞÆ÷¿ØÖÆ¶Ë
  53          //²â¾à´«¸ĞÆ÷´ò¿ªÒ»´Î£¬Ïàµ±ÓÚÆğÊ¼ĞÅºÅ£¬Ò»´Î¸ßÂö³å¼´´ò¿ªÒ»´Î
  54          sbit sensor_on=P0^0;
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 2   

  55          
  56          //µç´ÅÌú
  57          sbit MagentControl_1=P2^2;
  58          sbit MagentControl_2=P2^3;
  59          
  60          //Ê°ÒôÆ÷¿ØÖÆ ADµÄ6ºÅÍ¨µÀÎªÊ°ÒôÆ÷µÄÒôÁ¿¼ì²é¶Ë
  61          sbit VoiceControl=P2^4;//Ê°ÒôÆ÷¿ØÖÆ¶Ë
  62          
  63          //sbit upSignal=P0^4;//Ì§ÆğĞÅºÅ
  64          //sbit downSignal=P0^3;//µ¹µØĞÅºÅ
  65          
  66          //µç³Ø¿ØÖÆ      ADµÄ1ºÅÍ¨µÀÎªµç³ØµÄµçÁ¿¼ì²â¶Ë£¬¿ØÖÆ³äµç¿ª¹Ø£¬0Îª³äµç£¬1Îª²»³äµç
  67          sbit BatteryControl=P1^2;
  68          
  69          unsigned char count=0;//Êı¾İ½ÓÊÕ²¿·ÖµÄ¼ÆÊıÆ÷
  70          
  71          unsigned int lastAddr=0;//ÉÏÒ»´Î½ÓÊÕµ½µÄ±àÂëµÄµØÖ·
  72          
  73          unsigned int time0Count_1=0;//×÷ÎªÈıÖá´«¸ĞÆ÷Á½¸öÂö³åÖ®¼äµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  74          unsigned int time0Count_2=0;//×÷ÎªÈıÖá´«¸ĞÆ÷µÄ¼ÆÊ±
  75          unsigned int time0Count_3=0;//¶¨Ê±Æ÷T0µÄ¼ÆÊı
  76          unsigned int time0Count_4=0;//×÷ÎªÌ§ÆğÂö³åµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  77          unsigned int time0Count_5=0;//×÷Îªµ¹µØÂö³åµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  78          
  79          bit SensorFlag=0; //ÈıÖá´«¸ĞÆ÷µÄµÍµçÆ½±êÖ¾Î»
  80          unsigned char  SensorCount=0; //×÷ÎªÈıÖá´«¸ĞÆ÷Âö³åµÄ¼ÆÊı
  81          
  82          unsigned char TestFlag=0;       //1¡¢2¡¢3·Ö±ğÎªÃ¿´Î½ÓÊÕµ½¸½»ú·¢ËÍÀ´Êı¾İºóµÄ¼ÆÊı£¬ÔÚ´®¿ÚµÄ³É¹¦Ö¸ÁîÀï»áÖ´ĞĞ½«È¥¹éÁ
             -ãµÄ²Ù×÷
  83                                                  //Èç¹ûÁ¬Ğø3´Î¶¼Ã»ÓĞ¹éÁã£¬ÔòËµÃ÷²»ÔÚ³¡ÁË
  84          unsigned char ModeFlag=1;       //Ä£Ê½Ñ¡ÔñÎ»£¬1ÔòÓÃÄ£Ê½1,2ÔòÓÃÄ£Ê½2,3ÔòÎªÄ£Ê½3
  85          
  86          bit alarmFlag=0;//±¨¾¯ÓïÒôµÄ¿ªÆô±êÖ¾
  87          bit alarmFlag2=0;//±¨¾¯ÓïÒô±êÖ¾2
  88          unsigned char alarmCount=0;//±¨¾¯ÓïÒôµÄ´ÎÊı
  89          
  90          //bit threeFlag=0;//ÈıÂ·Ñ­»·¿ª¹Ø±êÖ¾
  91          
  92          bit voiceFlag=0;
  93          //bit downUpFlag=0;  //µ¹µØºÍÌ§Æğ¼ì²â±êÖ¾
  94          
  95          //bit downFlag=0;//µ¹µØµÄ±êÖ¾
  96          //bit upFlag=0;//Ì§ÆğµÄ±êÖ¾
  97          //bit downFlagSend=0;//µ¹µØ·¢ËÍµÄ±êÖ¾
  98          //bit upFlagSend=0;//Ì§Æğ·¢ËÍµÄ±êÖ¾
  99          
 100          //sensor_onÖ®ºóµÄÊ±¼ä¼ÆÊı
 101          unsigned char sensor_off=0;                              //±íÊ¾sensor_on¸ßÂö³åÖ®ºóµÄµÍÂö³å
 102          unsigned char sensor_off_count=0;                //µÍÂö³åµÄ¸öÊı
 103          unsigned char sensor_on_count=0;                 //¸ßÂö³åµÄ¸öÊı
 104          unsigned char sensor_pulse_count=0;              //ÔÚsensor_off=1µÄÊ±ºò£¬¸ßÂö³åÏàÍ¬³¤¶ÈµÄ´ÎÊı¡£
 105          
 106          //×÷Îª½ÓÊÕºÍ·¢ËÍµÄ»º´æÇø
 107          unsigned char TxRxBuf[28]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
             -,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
 108          
 109          //Ò»¸öÍ·×Ö½Ú£¬Ò»¸öµØÖ·×Ö½Ú£¬Ò»¸öÃüÁî×Ö½Ú£¬Á½¸ö±àÂëµØÖ·×Ö½Ú£¬Á½¸ö±àÂë
 110          unsigned char myTxRxData[7]={0x00,0x00,0x00,0x00,0x00,0x00,0x00};//´¦ÀíÍêºóµÄÍ¨ĞÅÊı¾İµÄ»º³åÇø
 111          
 112          unsigned int Check2=0;//µçÁ¿¼ì²â
 113          unsigned char Check1=0;//×÷ÎªAD¼ì²âÖµ£¬Ê°ÒôÆ÷¼ì²â£¬Æ½Ê±ÔëÉùÎª1VÒÔÄÚ£¬ÓĞĞÅºÅÊ±Îª1.5V
 114          
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 3   

 115          bit receiveFlag=0;//½ÓÊÕµ½Êı¾İ±êÖ¾
 116          bit commuFlag=0;//¿ªÆôÍ¨ĞÅ±êÖ¾
 117          
 118          unsigned char DataBetween=0;//×÷Îª½ÓÊÕÊı¾İµÄÖĞ¼ä±äÁ¿
 119          unsigned char RecData=0;//½ÓÊÕµ½µÄÊı¾İ
 120          unsigned char DataTime=0;//×÷Îª½ÓÊÕµÄÊı¾İµÄÒÆÎ»´ÎÊı¼ÆÊı
 121          bit ComFlag=1;//×öÉÏÉıÑØµÄÒ»¸ö±êÖ¾
 122          //unsigned int newAddr=0;
 123          unsigned char T1highcount=0;       //¶¨Ê±Æ÷T1ÔÚÃ»ÓĞĞÅºÅµ½À´µÄÊ±ºò£¬¶Ô¸ßµçÆ½¼ÆÊı£¬Ò»µ©³¬¹ıÄ³¸öÖµ£¬Ôò½«Datatime
             -Çå0
 124          //unsigned char T1highcount2=0;         //µ±P11ÎªµÍµçÆ½Ê±£¬ÀïÃæµÄ¸ßµçÆ½¼ÆÊı
 125          
 126          //¹¦·Å¿ª¹Ø¿ØÖÆ£¬1Îª´ò¿ª¹¦·Å£¬0Îª¹Ø±Õ¹¦·Å
 127          sbit PAshutdown=P1^4;
 128          
 129          //¶¨Òåµç´ÅÌú×ª¶¯Óë·ñ
 130          unsigned char magnetflag=0;
 131          
 132          //¶¨ÒåÒ»¸ö¼ÆÊı£¬À´±íÊ¾ĞÅºÅ½ÓÊÕºó£¬¶à³¤Ê±¼äÊ¹½ÓÊÕ»ú´ò¿ª£¬¼´¿ØÖÆSwitchControlµÄ¸ßµçÆ½Ê±¼ä¡£
 133          unsigned int SwitchControlcount=0;
 134          
 135          //·¢ËÍ±àÂëĞÅºÅ±êÖ¾Î»
 136          unsigned char commode2_flag=0; //·¢ËÍ±àÂë2µÄ±êÖ¾Î»
 137          //unsigned char commode3_flag=0; //·¢ËÍ±àÂë3µÄ±êÖ¾Î»
 138          
 139          //º¯ÊıÉùÃ÷
 140          void ComMode_1_Data(void);      //·¢ËÍÄ£Ê½1±àÂë
 141          void ComMode_2_Data(void);//·¢ËÍÄ£Ê½2±àÂë
 142          void ComMode_22_Data(void);//·¢ËÍÄ£Ê½2±àÂë
 143          void ComMode_3_Data(void);//·¢ËÍÄ£Ê½3±àÂë
 144          void ComMode_4_Data(void);//·¢ËÍÌ§Æğ±àÂë
 145          void ComMode_5_Data(void);//·¢ËÍµ¹µØ±àÂë
 146          
 147          //void codeData(unsigned char *doData,unsigned char len);               //±àÂë ,µçÆ½1±äÎª0011£¬µçÆ½0±äÎª1100
 148          //void transCode(unsigned char *doData,unsigned char len);//½âÂë£¬½«½ÓÊÕµ½µÃÊı¾İ»¹Ô­
 149          
 150          //t=1Ê±£¬ÑÓ³Ù100us×óÓÒ
 151          void Delay3(unsigned int t)
 152          {
 153   1              unsigned int i,j;
 154   1              for(i=0;i<t;i++)                
 155   1              for(j=0;j<19;j++);
 156   1      }
 157          
 158          void Delay33(unsigned int t)
 159          {
 160   1              unsigned int i,j;
 161   1              for(i=0;i<t;i++)                
 162   1              for(j=0;j<26;j++);
 163   1      }
 164          
 165          //init signal£¬·¢ËÍ±àÂëĞÅºÅÇ°µÄÆğÊ¼ĞÅºÅ£¬ÓÃÓÚ½«½ÓÊÕ»úµÄ×Ô¶¯ÔöÒæ´ò¿ª
 166          void initsignal()
 167          {
 168   1              unsigned char k,k1;
 169   1              unsigned char mystartbuffer=0xaa;
 170   1              for(k1=0;k1<3;k1++)
 171   1              {
 172   2                      for(k=0;k<8;k++)
 173   2                      {
 174   3                              if((mystartbuffer&0x80)==0x80)//Îª1
 175   3                              {
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 4   

 176   4                                      P10=0;
 177   4                                      Delay3(80);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 178   4                              }
 179   3                              else//Îª0µÄÇé¿ö
 180   3                              {
 181   4                                      P10=0;
 182   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 183   4                              }
 184   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 185   3                              mystartbuffer<<=1;
 186   3                              Delay3(150);//ÑÓÊ±Òª´óÓÚ2ms
 187   3                      }
 188   2                      mystartbuffer=0xaa;
 189   2                      Delay3(150);
 190   2              }
 191   1              P10=1;
 192   1              Delay3(80);
 193   1      }
 194          
 195          void main()
 196          {
 197   1      //      unsigned int newAddr=0;
 198   1      
 199   1              noVoice();
 200   1      
 201   1      //      InitUART();
 202   1              InitT0();
 203   1              InitT1();
 204   1      //      TI=0;
 205   1      //      RI=0;
 206   1      
 207   1      //      SwitchControl=1;         //¿ªÆğ½ÓÊÕ»ú£¬¿ØÖÆ¶ËÎªµÍµçÆ½
 208   1      
 209   1      //      onePin=0;
 210   1      //      twoPin=0;
 211   1              sensor_on=0;
 212   1      
 213   1      //      upSignal=1;
 214   1      //      downSignal=1;
 215   1      
 216   1      //      ES=1;
 217   1              ET0=1;
 218   1              ET1=1;
 219   1      //      PS=1;
 220   1              PT1=1;
 221   1              EA=1;
 222   1              P10=1;
 223   1      //      P11=1;
 224   1      
 225   1              BatteryControl=0;       //¸½»úÉÏµçµÄÊ±ºòÖÃ0£¬¼´¿ÉÒÔ³äµç£¬µç³ØÔÚÃ»ÓĞ³äÂúµÄÇé¿öÏÂÎªµÍµçÆ½
 226   1              myPwm();        //¿ª·¢Éä»ú
 227   1              VoiceControl=1;   //ÉÏµçµÄÊ±ºò£¬Ê°ÒôÆ÷´ò¿ª
 228   1              PAshutdown=0;           //½«¹¦·Å¹Ø±Õ
 229   1      
 230   1              MagentControl_1=0;//¹Ø±Õ´ÅÌú
 231   1              MagentControl_2=1;
 232   1              Delay(27);
 233   1              MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 234   1              MagentControl_2=0;
 235   1              magnetflag=0;
 236   1      
 237   1              commode2_flag=0;
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 5   

 238   1      
 239   1              while(1)
 240   1              {
 241   2                      Check1=GetADCResult(5);//Ê°ÒôÆ÷µÄ¼ì²â
 242   2      //              Delay(500);
 243   2                      if(Check1>=0x99)//ÉèÖÃ±È½ÏµçÑ¹£¬´Ë´¦Îª3VÉèÖÃ
 244   2                      {
 245   3                              PAshutdown=1;   //Ê°ÒôÆ÷³¬¹ıÄ³¸öµçÑ¹Ê±£¬´ò¿ª¹¦·Å
 246   3                      }
 247   2                      else
 248   2                      {
 249   3                              PAshutdown=0;   //Ê°ÒôÆ÷Ò»µ©µÍÓÚÄ³¸öµçÑ¹£¬Ôò¹Ø±Õ¹¦·Å
 250   3                      }
 251   2      
 252   2                      Check2=GetADCResult(6);//µçÁ¿¼ì²â
 253   2                      if(Check2>=0x3cf) //±íÊ¾µç³Ø³ä°üÁË
 254   2                      {
 255   3                              BatteryControl=1;//¿ªÂ©Ä£Ê½£¬ÕâÑùÎª¸ß×èÌ¬       
 256   3                      }
 257   2                      else
 258   2                      {
 259   3                              BatteryControl=0;//µç³ØÔÚÃ»ÓĞ³äÂúµÄÇé¿öÏÂÎªµÍµçÆ½
 260   3                      }
 261   2      
 262   2                      if(SwitchControlcount==18000)
 263   2                      {
 264   3                              SwitchControl=0;
 265   3                              SwitchControlcount=0;   
 266   3                      }
 267   2              }
 268   1      }
 269          
 270          void timeT1() interrupt 3 //¶¨Ê±Æ÷1ÖĞ¶Ï½ÓÊÕÊı¾İ
 271          {
 272   1      //      unsigned int newAddr=0;
 273   1              TH1=timer1H;//ÖØ×°ÔØ
 274   1              TL1=timer1L;
 275   1      
 276   1              if(SwitchControl==1)
 277   1              {
 278   2                      SwitchControlcount++;
 279   2              }
 280   1              else
 281   1              {
 282   2                      if(P11==0)//Õı³£Çé¿öÎª¸ßµçÆ½,ÓĞµÍµçÆ½ËµÃ÷ÓĞĞÅºÅ
 283   2                      {
 284   3                              DataBetween++;
 285   3                              ComFlag=0;
 286   3                              if(DataBetween==150)//µÍµçÆ½³ÖĞøµÄ×î´óÊ±¼ä      
 287   3                              {
 288   4                                      DataBetween=0;
 289   4                              }
 290   3                      }
 291   2                      else//Îª¸ßµçÆ½ÁË
 292   2                      {
 293   3                              if(ComFlag==0)//ËµÃ÷ÓĞÒ»¸öµÍµçÆ½
 294   3                              {
 295   4                                      ComFlag=1;
 296   4      //                              RecData<<=1;
 297   4              
 298   4                                      if((DataBetween>60)&&(DataBetween<=100))        //µÍµçÆ½³ÖĞøµÄÊ±¼äĞ¡ÓÚ10ms£¬ÔòÎª0
 299   4                                      {
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 6   

 300   5                                              RecData<<=1;
 301   5                                              RecData &= 0xfe;
 302   5                                              DataTime++;
 303   5                                              T1highcount=0;
 304   5                                      }
 305   4                                      else if((DataBetween>100))//µÍµçÆ½³ÖĞøµÄÊ±¼ä´óÓÚ4.5ms£¬ÔòÎª1
 306   4                                      {
 307   5                                              RecData<<=1;
 308   5                                              RecData |= 0x01;
 309   5                                              DataTime++;
 310   5                                              T1highcount=0;
 311   5                                      }
 312   4                                      else
 313   4                                      {
 314   5                                              T1highcount++;  
 315   5                                      }
 316   4              
 317   4                                      DataBetween=0;
 318   4      //                              DataTime++;
 319   4                              }
 320   3                              else
 321   3                              {
 322   4                                      T1highcount++;
 323   4                                      if(T1highcount>=120)
 324   4                                      {
 325   5                                              DataTime=0;
 326   5                                              ComFlag=1;
 327   5                                              count=0;
 328   5                                      }               
 329   4                              }
 330   3                      }
 331   2              //      P01=~P01;
 332   2              
 333   2                      if(DataTime==8)//ËµÃ÷Ò»¸ö×Ö½ÚµÄÊı¾İÒÑ¾­½ÓÊÜÍêÈ«
 334   2                      {
 335   3                              DataTime=0;
 336   3                              myTxRxData[count]=RecData;
 337   3                              if(count==0&&myTxRxData[0]==CmdHead)
 338   3                              {
 339   4                                      count=1;
 340   4                              }
 341   3                              else if(count==1&&myTxRxData[1]==MyAddress)
 342   3                              {
 343   4                                      count=2;
 344   4              
 345   4                              }
 346   3                              else if(count>=2&&count<=5)
 347   3                              {
 348   4                                      count++;
 349   4                              }
 350   3                              else if(count==6)
 351   3                              {
 352   4                                  receiveFlag=1;
 353   4                                      count=0;
 354   4                              }
 355   3                              else 
 356   3                              {
 357   4                                      count=0;
 358   4                              }
 359   3                      }
 360   2              
 361   2                      if(receiveFlag==1)
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 7   

 362   2                      {
 363   3                              receiveFlag=0;
 364   3                              SwitchControl=1;
 365   3              //              transCode(TxRxBuf,0x1c);//½«½ÓÊÕµ½µÃÊı¾İ½âÂë    
 366   3              //              ½âÎöÃüÁî
 367   3                              switch(myTxRxData[2]) //¶ÔÊı¾İÖ¡ÀïµÄÃüÁî½øĞĞ´¦Àí
 368   3                              {
 369   4                                      case CmdStart://ÈôÊÇ¿ª»úÖ¸Áî£¬Ö´ĞĞ¿ª»ú²Ù×÷
 370   4                                      {
 371   5              //ÔÚÕâÀï¼ÓÈë¿ª»úµÄÊ±ºòÒª×öµÄÊÂÇé
 372   5                                              ModeControl_1=1;        //·¢Éä»úÄ£Ê½¿ØÖÆ¶Ë,¿ª»úÊ±Îª30MÄ£Ê½
 373   5                                          VoiceControl=1;             //¿ª»úÊ±Ö÷»ú¿ªÊ°ÒôÆ÷
 374   5                                              
 375   5                                              if(magnetflag==0)
 376   5                                              {
 377   6                                                      MagentControl_1=1;//¿ªÆô´ÅÌú
 378   6                                                      MagentControl_2=0;
 379   6                                                      Delay(27);
 380   6                                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 381   6                                                      MagentControl_2=0;
 382   6                                                      magnetflag=1;
 383   6                                              }
 384   5              
 385   5                                              SensorControl=1;
 386   5                                              commuFlag=1; //¿ªÆôÍ¨ĞÅ
 387   5      
 388   5      //                                      commode2_flag=1;
 389   5      //                                      commode3_flag=0;
 390   5              //                              VoiceControl=1;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 391   5              //                              SC_Speech(11);  //
 392   5              //                              Delay(100);
 393   5              //      
 394   5              //                              if(Check2>=0x3cf)//ÉèÖÃ±È½ÏµçÑ¹£¬´Ë´¦Îª4V,ÒÔ4.2VÎª»ù×¼
 395   5              //                              {
 396   5              //                                      SC_Speech(10);  //4VµçÁ¿³ä×ãÌáÊ¾
 397   5              //                                      Delay(100);
 398   5              //              
 399   5              //                              }
 400   5              //                              else if(Check2<0x3cf&&Check2>=399)
 401   5              //                              {
 402   5              //                                      SC_Speech(9);  //3.8VµçÁ¿³ä×ãÌáÊ¾
 403   5              //                                      Delay(100);
 404   5              //                              }
 405   5              //                              else if(Check2<0x399&&Check2>=0x366)
 406   5              //                              {
 407   5              //                                      SC_Speech(8);  //3.6VµçÁ¿³ä×ãÌáÊ¾
 408   5              //                                      Delay(100);
 409   5              //                              }
 410   5              //                              else if(Check2<0x366)
 411   5              //                              {
 412   5              //                                      SC_Speech(7);  //µÍÓÚ3.6vµçÁ¿³ä×ãÌáÊ¾
 413   5              //                                      Delay(100);
 414   5              //                              }
 415   5              //
 416   5              //                              VoiceControl=0;//¿ªÆôÊ°ÉùÆ÷
 417   5                                      }
 418   4                                      break;
 419   4              
 420   4                                      case CmdStop:     //ÈôÊÇ¹Ø»úÖ¸Áî£¬Ö´ĞĞ¹Ø»ú²Ù×÷
 421   4                                      {
 422   5              //ÔÚÕâÀï¼ÓÈë¹Ø»úµÄÊ±ºòÒª×öµÄÊÂÇé
 423   5                                              
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 8   

 424   5                                              VoiceControl=0;//¹Ø±ÕÊ°ÉùÆ÷
 425   5              
 426   5                                              if(magnetflag==1)
 427   5                                              {
 428   6                                                      MagentControl_1=0;//¿ªÆô´ÅÌú
 429   6                                                      MagentControl_2=1;
 430   6                                                      Delay(27);
 431   6                                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 432   6                                                      MagentControl_2=0;
 433   6                                                      magnetflag=0;
 434   6                                              }
 435   5                                              SensorControl=1;//¹Ø±ÕÈıÖá´«¸ĞÆ÷
 436   5      
 437   5                                              commuFlag=0;//¹Ø±ÕÍ¨ĞÅ
 438   5      
 439   5                                              alarmFlag=0;//¹Ø±¨¾¯±êÖ¾Î»
 440   5                                              alarmCount=0;//±¨¾¯¼ÆÊı´ÎÊıÇåÁã
 441   5      
 442   5              //                              VoiceControl=1;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 443   5              //                              SC_Speech(12);  //
 444   5              //                              Delay(100);
 445   5              //      
 446   5              //                              if(Check2>=0x3cf)//ÉèÖÃ±È½ÏµçÑ¹£¬´Ë´¦Îª4V,ÒÔ4.2VÎª»ù×¼
 447   5              //                              {
 448   5              //                                      SC_Speech(10);  //µçÁ¿³ä×ãÌáÊ¾
 449   5              //                                      Delay(100);
 450   5              //                              }
 451   5              //                              else if(Check2<0x3cf&&Check2>=399)
 452   5              //                              {
 453   5              //                                      SC_Speech(9);  //µçÁ¿³ä×ãÌáÊ¾
 454   5              //                                      Delay(100);
 455   5              //                              }
 456   5              //                              else if(Check2<0x399&&Check2>=0x366)
 457   5              //                              {
 458   5              //                                      SC_Speech(8);  //µçÁ¿³ä×ãÌáÊ¾
 459   5              //                                      Delay(100);
 460   5              //                              }
 461   5              //                              else if(Check2<0x366)
 462   5              //                              {
 463   5              //                                      SC_Speech(7);  //µçÁ¿³ä×ãÌáÊ¾
 464   5              //                                      Delay(100);
 465   5              //                              }
 466   5              //
 467   5              //                              VoiceControl=0;//¿ªÆôÊ°ÉùÆ÷
 468   5                                      }
 469   4                                      break;
 470   4              
 471   4                                      case ComMode_1:  //¸½»ú·¢ËÍ¹ıÀ´µÄÖ»ÓÃÄ£Ê½1£¬ËµÃ÷ÏÖÔÚÊÇÕı³£µÄ£¬Êı¾İ²¿·ÖÎªÊı×éµÄµÚÒ»ºÍµÚ¶ş¸ö×Ö½Ú£¬ÎªÃÜÂë
             -±íÄÚµÄÕâ¸ö±àÂëµÄ¿ªÊ¼×Ö½ÚµÄÄÇ¸öµØÖ·£¬È»ºóÌî³äÊı¾İÖ¡£¬°ÑÃÜÂë±íµÄÊı¾İ·¢ËÍ³öÈ¥
 472   4                                      {
 473   5      //                                      commode2_flag=1;
 474   5                                              ComMode_22_Data();//»Ø¸´È·ÈÏĞÅºÅ
 475   5                                              alarmFlag=0;//¹Ø±¨¾¯±êÖ¾Î»
 476   5                                              alarmCount=0;//±¨¾¯¼ÆÊı´ÎÊıÇåÁã
 477   5                                              commode2_flag=0;  //¹Ø±Õ±àÂë2ĞÅºÅµÄ·¢ËÍ
 478   5      //                                      commode3_flag=0;
 479   5              
 480   5              //                              lastAddr=newAddr;
 481   5                                              SensorControl=1;        //¹Ø±ÕÈıÖá´«¸ĞÆ÷
 482   5      //                                      downUpFlag=0;           //¹Øµ¹µØ¡¢Ì§Æğ¼ì²â
 483   5                                                                      
 484   5      //                                      if(TestFlag>=3)//ÓĞÒì³£Çé¿ö»Ö¸´Ê±£¬¿ªÆôµç×ÓËø
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 9   

 485   5      //                                      {
 486   5                                              if(magnetflag==0)
 487   5                                              {
 488   6                                                      MagentControl_1=1;//¿ªÆô´ÅÌú
 489   6                                                      MagentControl_2=0;
 490   6                                                      Delay(27);
 491   6                                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 492   6                                                      MagentControl_2=0;
 493   6                                                      magnetflag=1;
 494   6                                              }
 495   5      //                                      }
 496   5                                              TestFlag=0;     
 497   5                                              
 498   5                                              if(ModeFlag==3||ModeFlag==2)
 499   5                                              {
 500   6                                              //»Ö¸´ÁËÕı³££¬×öÏàÓ¦¸´Î»¶¯×÷
 501   6                                                      ModeFlag=1;
 502   6                                              }
 503   5                                      }
 504   4                                      break;
 505   4              /*
 506   4                                              case ComMode_1:  //¸½»ú·¢ËÍ¹ıÀ´µÄÖ»ÓÃÄ£Ê½1£¬ËµÃ÷ÏÖÔÚÊÇÕı³£µÄ£¬Êı¾İ²¿·ÖÎªÊı×éµÄµÚÒ»ºÍµÚ¶ş¸ö×Ö½Ú£¬ÎªÃÜÂ
             -ë±íÄÚµÄÕâ¸ö±àÂëµÄ¿ªÊ¼×Ö½ÚµÄÄÇ¸öµØÖ·£¬È»ºóÌî³äÊı¾İÖ¡£¬°ÑÃÜÂë±íµÄÊı¾İ·¢ËÍ³öÈ¥
 507   4                                              {
 508   4              
 509   4              
 510   4              //                                                      newAddr=(newAddr|myTxRxData[4])<<8;//¸ß°ËÎ»
 511   4              //                                                      newAddr=newAddr+myTxRxData[3];             //µÍ°ËÎ»
 512   4              
 513   4                      
 514   4                      
 515   4                                                                      if(PassWord[lastAddr+1]==myTxRxData[5]&&PassWord[lastAddr+2]==myTxRxData[6])//ÃÜÂë±íÊÇ·ñ¹ö¶¯ÁËÒ»¸ö
             -È»ºó¶ÔµÄ×¡
 516   4                                                                      {
 517   4                                                                              
 518   4              //                                                              if(newAddr==0 &&( (lastAddr-newAddr)>=997 ||(lastAddr-newAddr)==0))
 519   4              //                                                              { 
 520   4                                                                              
 521   4              //                                                              if(newAddr>=999)
 522   4              //                                                              {
 523   4              //                                                                      newAddr=0;
 524   4              //                                                                      lastAddr=newAddr;//±£´æÕâ´ÎµÄÃÜÂëµØÖ·£¬ÎªÏÂ´ÎµØÖ·×öĞ£¶ÔÊ¹ÓÃ
 525   4              //                                                              }
 526   4              //                                                              else 
 527   4              //                                                              {
 528   4              //                                                                      lastAddr=newAddr;//±£´æÕâ´ÎµÄÃÜÂëµØÖ·£¬ÎªÏÂ´ÎµØÖ·×öĞ£¶ÔÊ¹ÓÃ
 529   4              //                                                                      newAddr+=1;//µØÖ·¹ö¶¯Ò»´Î
 530   4              //                                                              }
 531   4              
 532   4                                                                              ComMode_1_Data(newAddr);//»Ø¸´È·ÈÏĞÅºÅ
 533   4                                                                              
 534   4                      
 535   4                                                                              alarmFlag=0;//¹Ø±¨¾¯±êÖ¾Î»
 536   4                                                                              alarmCount=0;//±¨¾¯¼ÆÊı´ÎÊıÇåÁã
 537   4                      
 538   4                                                                              lastAddr=newAddr;
 539   4                                                                              SensorControl=0;//¹Ø±ÕÈıÖá´«¸ĞÆ÷
 540   4                                                                              
 541   4                                                                         if(TestFlag>=3)//ÓĞÒì³£Çé¿ö»Ö¸´Ê±£¬¿ªÆôµç×ÓËø
 542   4                                                                         {
 543   4                                                                                      MagentControl_1=0;//¿ªÆô´ÅÌú
 544   4                                                                                      MagentControl_2=1;
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 10  

 545   4                                                                                      Delay(1);
 546   4              //                                                                      MagentControl_1=1;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 547   4              //                                                                      MagentControl_2=1;
 548   4                                                                              
 549   4                                                                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 550   4                                                                                      MagentControl_2=0;
 551   4                                                                              }
 552   4                      
 553   4                                                                              TestFlag=0;     
 554   4                                                                              
 555   4                                                                              if(ModeFlag==3||ModeFlag==2)
 556   4                                                                              {
 557   4                                                                              //»Ö¸´ÁËÕı³££¬×öÏàÓ¦¸´Î»¶¯×÷
 558   4                                                                                      ModeFlag=1;
 559   4                                                                              }
 560   4                                                                      }
 561   4              
 562   4                                                                      else//µØÖ·¹ö¶¯²»ÏàµÈ
 563   4                                                                      {
 564   4                                                                              newAddr=select(myTxRxData[5]);  //²éÕÒµÚÒ»¸öÃÜÂëµÄµØÖ·
 565   4                                                                              if(newAddr!=1001)//ÕÒµ½ÁËÕâ¸ö
 566   4                                                                              {
 567   4                                                                                      if(newAddr>=999)
 568   4                                                                                      {
 569   4                                                                                              newAddr=0;
 570   4                                                                                              lastAddr=newAddr;//±£´æÕâ´ÎµÄÃÜÂëµØÖ·£¬ÎªÏÂ´ÎµØÖ·×öĞ£¶ÔÊ¹ÓÃ
 571   4                                                                                      }
 572   4                                                                                      else
 573   4                                                                                      {
 574   4                                                                                              lastAddr=newAddr;//±£´æÕâ´ÎµÄÃÜÂëµØÖ·£¬ÎªÏÂ´ÎµØÖ·×öĞ£¶ÔÊ¹ÓÃ
 575   4                                                                                              newAddr+=1;//µØÖ·¹ö¶¯Ò»´Î
 576   4                                                                                      }
 577   4              
 578   4                                                                                      ComMode_1_Data(newAddr);//»Ø¸´È·ÈÏĞÅºÅ
 579   4              
 580   4                                                                                      alarmFlag=0;//¹Ø±¨¾¯±êÖ¾Î»
 581   4                                                                                      alarmCount=0;//±¨¾¯¼ÆÊı´ÎÊıÇåÁã
 582   4                              
 583   4                                                                                      lastAddr=newAddr;
 584   4                                                                                      SensorControl=0;//¹Ø±ÕÈıÖá´«¸ĞÆ÷
 585   4                                                                                      
 586   4                                                                                 if(TestFlag>=3)//ÓĞÒì³£Çé¿ö»Ö¸´Ê±£¬¿ªÆôµç×ÓËø
 587   4                                                                                 {
 588   4                                                                                              MagentControl_1=0;//¿ªÆô´ÅÌú
 589   4                                                                                              MagentControl_2=1;
 590   4                                                                                              Delay(1);
 591   4                                                                                              MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 592   4                                                                                              MagentControl_2=0;
 593   4                                                                                      }
 594   4                              
 595   4                                                                                      TestFlag=0;     
 596   4                                                                                      
 597   4                                                                                      if(ModeFlag==3||ModeFlag==2)
 598   4                                                                                      {
 599   4                                                                                      //»Ö¸´ÁËÕı³££¬×öÏàÓ¦¸´Î»¶¯×÷
 600   4                                                                                              ModeFlag=1;
 601   4                                                                                      }
 602   4                                                                              }
 603   4                                                                      }
 604   4                      //                                                      }
 605   4                      //                                                      else if(newAddr<=1000&&(newAddr-lastAddr<=3))
 606   4                      //                                                      else if((newAddr-lastAddr)<=3)
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 11  

 607   4                      //                                                      {
 608   4                      //                                                              
 609   4                      //                                                              TestFlag=0;
 610   4                      //                                                              lastAddr=newAddr;
 611   4                      //                                                              SensorControl=1;//¹Ø±ÕÈıÖá´«¸ĞÆ÷
 612   4                      //                                                              ComMode_1_Data(newAddr);//»Ø¸´È·ÈÏĞÅºÅ
 613   4                      //                                                              if(ModeFlag==2)
 614   4                      //                                                              {
 615   4                      //                                                              //»Ö¸´ÁËÕı³££¬×öÏàÓ¦¸´Î»¶¯×÷
 616   4                      //                                                                      ModeFlag=1;
 617   4                      //                                                              }
 618   4                      //                                                      }
 619   4                      
 620   4                                                                      }
 621   4                                              }
 622   4                                              break;
 623   4      */      
 624   4                              }
 625   3                      }
 626   2              }
 627   1      
 628   1              if(sensor_on==1)
 629   1              {
 630   2                      sensor_on_count++;
 631   2                      if(sensor_on_count>=15)
 632   2                      {
 633   3                              sensor_on=0;
 634   3                              sensor_on_count=0;
 635   3                              sensor_off=1;
 636   3                              sensor_off_count=0;
 637   3                      }
 638   2              }
 639   1      
 640   1              if(sensor_off==1)
 641   1              {
 642   2                      sensor_off_count++;
 643   2                      
 644   2                      if(ReceWave==1)
 645   2                      {
 646   3                              time0Count_2++;
 647   3                              if(time0Count_2>3)
 648   3                              {
 649   4                                      alarmFlag2=1;
 650   4                                      time0Count_2=0;
 651   4                              }
 652   3                      }
 653   2                      else
 654   2                      {
 655   3                              time0Count_2=0;
 656   3                      }
 657   2      
 658   2                      if(sensor_off_count>=80)
 659   2                      {
 660   3                              sensor_off=0;
 661   3                              sensor_off_count=0;
 662   3                      }
 663   2      
 664   2              }
 665   1      }
 666          
 667          void time0() interrupt 1        //×÷ÎªÕû¸öÏµÍ³×Ô¼ºµÄÊ±ÖÓ
 668          {
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 12  

 669   1              TH0=timer0H;//ÖØ×°ÔØ
 670   1              TL0=timer0L;
 671   1              time0Count_3++;
 672   1      
 673   1              if(time0Count_3>=60)//´®¿ÚÃ¿1S½ÓÊÜÒ»´ÎµÄÊı¾İµÄÊ±¼ä±êÖ¾
 674   1              {
 675   2                      if(commuFlag==1)//ËµÃ÷¿ªÆôÁËÍ¨ĞÅ
 676   2                      {
 677   3                              TestFlag++;
 678   3      
 679   3                              if(TestFlag>=3&&ModeFlag==1)//ËµÃ÷Ã»ÓĞ½ÓÊÕµ½Êı¾İÒÑ¾­ÓĞ3´ÎÁË£¬¸½»úÒÑ¾­³öÁË3M£¬ÏÖÔÚ¾ÍÒª¼Ó´ó¹¦ÂÊ£¬ÇĞ»»µ½Ä£
             -Ê½2,30MÔÙ¿´ÄÜ²»ÄÜ½ÓÊÕµ½Êı¾İ
 680   3                              {
 681   4                                      TestFlag=4;
 682   4                                      if(ModeFlag==1)
 683   4                                      {
 684   5      //                                      ComMode_2_Data(lastAddr);//Ïò¸½»ú·¢ËÍ±àÂë2
 685   5      //                                      SendData(0xac);//²âÊÔÊı¾İ       
 686   5                                              if(magnetflag==1)
 687   5                                              {
 688   6                                                      MagentControl_1=0;//¿ªÆô´ÅÌú
 689   6                                                      MagentControl_2=1;
 690   6                                                      Delay(27);
 691   6                                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 692   6                                                      MagentControl_2=0;
 693   6                                                      magnetflag=0;
 694   6                                              }
 695   5                      
 696   5                                              SensorControl=0;//¿ªÆôÈıÖá´«¸ĞÆ÷
 697   5      //                                      downUpFlag=1;//¿ªÆôµ¹µØ¡¢Ì§Æğ±êÖ¾
 698   5                                              ModeFlag=2;
 699   5              
 700   5      //                                      ComMode_2_Data();//Ïò¸½»ú·¢ËÍ±àÂë2
 701   5                                              commode2_flag=1;
 702   5                                      }       
 703   4                              }
 704   3      
 705   3                              if(commode2_flag==1)
 706   3                              {
 707   4                                      ComMode_2_Data();       //Ïò¸½»ú·¢ËÍ±àÂë2       
 708   4                              }
 709   3                      }
 710   2                      time0Count_3=0;
 711   2              }
 712   1      
 713   1              if(SensorControl==0)//¼ì²âÈıÖá´«¸ĞÆ÷ÊÇ·ñ´ò¿ª
 714   1              {
 715   2                      sensor_on=1;    //´¥·¢Ò»´Î²â¾à
 716   2      /*              
 717   2                      if(ReceWave==1)//ËµÃ÷ÓĞ´¥·¢Çé¿ö£¬¿ªÊ¼¼ÆÊ±
 718   2                      {
 719   2                              time0Count_2++;
 720   2                              if(time0Count_2>=10)//ËµÃ÷ÒÑ¾­´óÓÚ0.5S
 721   2                              {
 722   2                                      time0Count_2 =0;//¼ÆÊ±ÆÚÇåÁã
 723   2                                      SensorCount++;//ÈıÖá´«¸ĞÆ÷Âö³å¼ÆÊı¼Ó1
 724   2                                      alarmFlag2=1;//
 725   2                              }               
 726   2                      }
 727   2                      else if(ReceWave==0&&SensorCount!=0)//ËµÃ÷ÒÑ¾­ÓĞÒ»¸öÓĞÓÃµÄÂö³å
 728   2                      {
 729   2                              time0Count_1++;
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 13  

 730   2                              if(time0Count_1>=100)//´óÓÚ5S
 731   2                              {
 732   2                                      SensorCount=0;
 733   2                              }
 734   2                      }
 735   2      */
 736   2              }
 737   1       
 738   1              if(ModeFlag==2&&alarmFlag2==1)//ÈıÖá´«¸ĞÆ÷Âö³åµÄÏàÓ¦±¨¾¯
 739   1              {
 740   2      /*
 741   2                      if(SensorCount==1&&alarmFlag2==1)//ÈıÖá´«¸ĞÆ÷Ò»´Î´¥·¢,alarmFlag2¿ØÖÆ·¢Éù1´Î
 742   2                      {                                       
 743   2                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 744   2                              PAshutdown=1;  //ÏÈ¹Ø±ÕÊ°ÒôÆ÷£¬È»ºó´ò¿ª¹¦·Å
 745   2                              SC_Speech(1);  //¹Ø»úÓïÑÔÌáĞÑ
 746   2                              Delay(140);
 747   2                              PAshutdown=0;  //ÓïÒôÍê³Éºó£¬¹Ø±Õ¹¦·Å£¬È»ºó´ò¿ªÊ°ÒôÆ÷
 748   2                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 749   2                              alarmFlag2=0;
 750   2                      }
 751   2                      if(SensorCount==2&&alarmFlag2==1)//ÈıÖá´«¸ĞÆ÷¶ş´Î´¥·¢£¬alarmFlag2¿ØÖÆ·¢Éù1´Î
 752   2                      {
 753   2                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 754   2                              PAshutdown=1;
 755   2                              SC_Speech(2);  //¹Ø»úÓïÑÔÌáĞÑ
 756   2                              Delay(140);
 757   2                              PAshutdown=0;
 758   2                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 759   2                              alarmFlag2=0;
 760   2                      }
 761   2      */
 762   2      //              if(SensorCount>=3)//ÈıÖá´«¸ĞÆ÷Ò»´Î´¥·¢
 763   2      //              {
 764   2      //                      ComMode_3_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 765   2                              ModeFlag=3;//ÈıÖá´«¸ĞÆ÷ÒÑ¾­ÓĞ3´Î´¥·¢ÁË£¬Òª¸Ä±ä·¢ÉäÄ£Ê½ÁË
 766   2                              alarmFlag=1;//ÖÃÓïÒô±¨¾¯Î»
 767   2                              alarmFlag2=0;
 768   2                              SensorCount=0; //Âö³å¼ÆÊıÇåÁã
 769   2                              Delay(1);
 770   2                              commode2_flag=0;
 771   2                              ComMode_3_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 772   2      //                      commode3_flag=1;
 773   2      //              }
 774   2              }
 775   1      
 776   1              if(ModeFlag==3)
 777   1              {
 778   2                      if(alarmFlag==1)
 779   2                      {
 780   3                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 781   3                              PAshutdown=1;
 782   3                              SC_Speech(3);  //¹Ø»úÓïÑÔÌáĞÑ
 783   3                              Delay(120);
 784   3                              PAshutdown=0;
 785   3                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 786   3                      }
 787   2                      if(alarmFlag==1)
 788   2                      {
 789   3                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 790   3                              PAshutdown=1;
 791   3                              SC_Speech(4);  //¹Ø»úÓïÑÔÌáĞÑ
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 14  

 792   3                              Delay(190);
 793   3                              PAshutdown=0;
 794   3                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 795   3                      }
 796   2                      ComMode_3_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 797   2                      if(alarmFlag==1)
 798   2                      {
 799   3                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 800   3                              PAshutdown=1;
 801   3                              SC_Speech(3);  //¹Ø»úÓïÑÔÌáĞÑ
 802   3                              Delay(120);
 803   3                              PAshutdown=0;
 804   3                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 805   3                      }
 806   2                      if(alarmFlag==1)
 807   2                      {
 808   3                              VoiceControl=0;//Ê¹ÓÃÓïÒôÊ±Òª¹Ø±ÕÊ°ÉùÆ÷
 809   3                              PAshutdown=1;
 810   3                              SC_Speech(4);  //¹Ø»úÓïÑÔÌáĞÑ
 811   3                              Delay(190);
 812   3                              PAshutdown=0;
 813   3                              VoiceControl=1;//¿ªÆôÊ°ÉùÆ÷
 814   3                      }
 815   2                      ComMode_3_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 816   2                      if(alarmCount>=20) //µ÷½ÚÓïÒôµÄ¶ÎÊı
 817   2                      {
 818   3                              alarmCount=0;//Çå±¨¾¯¼ÆÊıÆ÷
 819   3                              alarmFlag=0;//Çå±¨¾¯±êÖ¾
 820   3                      }
 821   2                      alarmCount++;
 822   2              }
 823   1      }
 824          
 825          void ComMode_1_Data()//·¢ËÍ±ßÂë1
 826          {
 827   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 828   1      //      P0M2&=0xfd;
 829   1      //      myPwm();        //¿ª·¢Éä»ú
 830   1      //      ModeTurn=0;
 831   1      /*
 832   1              SendData(0x55);
 833   1              SendData(0xf0);
 834   1              SendData(0xaa);
 835   1              SendData(0x0f);
 836   1      */
 837   1              unsigned char i,n;
 838   1              ModeControl_1=1;//30M·¢Éä¹¦ÂÊ                           
 839   1      
 840   1              myTxRxData[0]=CmdHead;
 841   1              myTxRxData[1]=MyAddress;
 842   1              myTxRxData[2]=ComMode_1;
 843   1              myTxRxData[3]=0x00;
 844   1              myTxRxData[4]=0x00;
 845   1              myTxRxData[5]=0x00;
 846   1              myTxRxData[6]=0x00;
 847   1      
 848   1              initsignal();                                                                                                      
 849   1      
 850   1              for(i=0;i<7;i++)
 851   1              {
 852   2                      for(n=0;n<8;n++)
 853   2                      {
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 15  

 854   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 855   3                              {
 856   4                                      P10=0;
 857   4                                      Delay3(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 858   4                              }
 859   3                              else//Îª0µÄÇé¿ö
 860   3                              {
 861   4                                      P10=0;
 862   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 863   4                              }
 864   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 865   3                              myTxRxData[i]<<=1;
 866   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 867   3                      }
 868   2              }
 869   1      
 870   1      //      codeData(myTxRxData,7);
 871   1      //      SendNByte(TxRxBuf,28);
 872   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
 873   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 874   1      //      P0M2&=0xfd;
 875   1      //      ModeTurn=1;
 876   1      }
 877          
 878          void ComMode_2_Data()//·¢ËÍ±ßÂë2
 879          {
 880   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 881   1      //      P0M2&=0xfd;
 882   1      //      myPwm();        //¿ª·¢Éä»ú
 883   1      //      ModeTurn=0;
 884   1      /*
 885   1              SendData(0x55);
 886   1              SendData(0xf0);
 887   1              SendData(0xaa);
 888   1              SendData(0x0f);
 889   1      */
 890   1              unsigned char i,n;
 891   1              ModeControl_1=1;//30M·¢Éä¹¦ÂÊ
 892   1      
 893   1              myTxRxData[0]=CmdHead;
 894   1              myTxRxData[1]=MyAddress;
 895   1              myTxRxData[2]=0xc2;
 896   1              myTxRxData[3]=0x00;
 897   1              myTxRxData[4]=0x00;
 898   1              myTxRxData[5]=0x00;
 899   1              myTxRxData[6]=0x00;
 900   1      
 901   1              initsignal();
 902   1      
 903   1              for(i=0;i<7;i++)
 904   1              {
 905   2                      for(n=0;n<8;n++)
 906   2                      {
 907   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 908   3                              {
 909   4                                      P10=0;
 910   4                                      Delay3(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 911   4                              }
 912   3                              else//Îª0µÄÇé¿ö
 913   3                              {
 914   4                                      P10=0;
 915   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 16  

 916   4                              }
 917   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 918   3                              myTxRxData[i]<<=1;
 919   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
 920   3                      }
 921   2              }
 922   1      //      codeData(myTxRxData,7); //½øĞĞ±àÂë
 923   1      //      SendNByte(TxRxBuf,28);
 924   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
 925   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 926   1      //      P0M2&=0xfd;
 927   1      //      ModeTurn=1;
 928   1      }
 929          
 930          void ComMode_22_Data()//·¢ËÍ±ßÂë2
 931          {
 932   1              unsigned char i,n;
 933   1              ModeControl_1=1;//30M·¢Éä¹¦ÂÊ
 934   1      
 935   1              myTxRxData[0]=CmdHead;
 936   1              myTxRxData[1]=MyAddress;
 937   1              myTxRxData[2]=0xc2;
 938   1              myTxRxData[3]=0x00;
 939   1              myTxRxData[4]=0x00;
 940   1              myTxRxData[5]=0x00;
 941   1              myTxRxData[6]=0x00;
 942   1      
 943   1              initsignal();
 944   1      
 945   1              for(i=0;i<7;i++)
 946   1              {
 947   2                      for(n=0;n<8;n++)
 948   2                      {
 949   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 950   3                              {
 951   4                                      P10=0;
 952   4                                      Delay33(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 953   4                              }
 954   3                              else//Îª0µÄÇé¿ö
 955   3                              {
 956   4                                      P10=0;
 957   4                                      Delay33(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 958   4                              }
 959   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
 960   3                              myTxRxData[i]<<=1;
 961   3                              Delay33(50);//ÑÓÊ±Òª´óÓÚ2ms
 962   3                      }
 963   2              }
 964   1      }
 965          
 966          void ComMode_3_Data()//·¢ËÍ±ßÂë3
 967          {
 968   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
 969   1      //      P0M2&=0xfd;
 970   1      //      myPwm();        //¿ª·¢Éä»ú
 971   1      //      ModeTurn=0;
 972   1      /*
 973   1              SendData(0x55);
 974   1              SendData(0xf0);
 975   1              SendData(0xaa);
 976   1              SendData(0x0f);
 977   1      */
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 17  

 978   1              unsigned char i,n;
 979   1              ModeControl_1=0;//ÇĞ»»Îª300M·¢Éä
 980   1      
 981   1              myTxRxData[0]=CmdHead;
 982   1              myTxRxData[1]=MyAddress;
 983   1              myTxRxData[2]=ComMode_3;
 984   1              myTxRxData[3]=0x00;
 985   1              myTxRxData[4]=0x00;
 986   1              myTxRxData[5]=0x00;
 987   1              myTxRxData[6]=0x00;
 988   1      
 989   1              initsignal();
 990   1      
 991   1              for(i=0;i<7;i++)
 992   1              {
 993   2                      for(n=0;n<8;n++)
 994   2                      {
 995   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
 996   3                              {
 997   4                                      P10=0;
 998   4                                      Delay3(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
 999   4                              }
1000   3                              else//Îª0µÄÇé¿ö
1001   3                              {
1002   4                                      P10=0;
1003   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
1004   4                              }
1005   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
1006   3                              myTxRxData[i]<<=1;
1007   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
1008   3                      }
1009   2              }
1010   1      //      codeData(myTxRxData,7); //½øĞĞ±àÂë
1011   1      //      SendNByte(TxRxBuf,28);
1012   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
1013   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
1014   1      //      P0M2&=0xfd;
1015   1      //      ModeTurn=1;
1016   1              ModeControl_1=1;                //·¢ËÍ±àÂë3Íê³Éºó£¬½«Ä£Ê½ÓÖÇĞ»»³É30m¾àÀë
1017   1      }
1018          
1019          void ComMode_4_Data()//·¢ËÍÌ§Æğ±àÂë
1020          {
1021   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
1022   1      //      P0M2&=0xfd;
1023   1      //      myPwm();        //¿ª·¢Éä»ú
1024   1      //      ModeTurn=0;
1025   1      /*
1026   1              SendData(0x55);
1027   1              SendData(0xf0);
1028   1              SendData(0xaa);
1029   1              SendData(0x0f);
1030   1      */
1031   1              unsigned char i,n;
1032   1              ModeControl_1=0;//ÇĞ»»Îª300M·¢Éä
1033   1      
1034   1              myTxRxData[0]=CmdHead;
1035   1              myTxRxData[1]=MyAddress;
1036   1              myTxRxData[2]=ComMode_4;
1037   1              myTxRxData[3]=0x00;
1038   1              myTxRxData[4]=0x00;
1039   1              myTxRxData[5]=0x00;
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 18  

1040   1              myTxRxData[6]=0x00;
1041   1      
1042   1              initsignal();
1043   1      
1044   1              for(i=0;i<7;i++)
1045   1              {
1046   2                      for(n=0;n<8;n++)
1047   2                      {
1048   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
1049   3                              {
1050   4                                      P10=0;
1051   4                                      Delay3(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
1052   4                              }
1053   3                              else//Îª0µÄÇé¿ö
1054   3                              {
1055   4                                      P10=0;
1056   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
1057   4                              }
1058   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
1059   3                              myTxRxData[i]<<=1;
1060   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
1061   3                      }
1062   2              }
1063   1      //      codeData(myTxRxData,7); //½øĞĞ±àÂë
1064   1      //      SendNByte(TxRxBuf,28);
1065   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
1066   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
1067   1      //      P0M2&=0xfd;
1068   1      //      ModeTurn=1;
1069   1      }
1070          
1071          void ComMode_5_Data()//·¢ËÍµ¹µØ±àÂë
1072          {
1073   1      //      P0M1&=0xfd;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
1074   1      //      P0M2&=0xfd;
1075   1      //      myPwm();        //¿ª·¢Éä»ú
1076   1      //      ModeTurn=0;
1077   1      /*
1078   1              SendData(0x55);
1079   1              SendData(0xf0);
1080   1              SendData(0xaa);
1081   1              SendData(0x0f);
1082   1      */
1083   1              unsigned char i,n;
1084   1              ModeControl_1=0;//ÇĞ»»Îª300M·¢Éä
1085   1      
1086   1              myTxRxData[0]=CmdHead;
1087   1              myTxRxData[1]=MyAddress;
1088   1              myTxRxData[2]=ComMode_5;
1089   1              myTxRxData[3]=0x00;
1090   1              myTxRxData[4]=0x00;
1091   1              myTxRxData[5]=0x00;
1092   1              myTxRxData[6]=0x00;
1093   1      
1094   1              initsignal();
1095   1      
1096   1              for(i=0;i<7;i++)
1097   1              {
1098   2                      for(n=0;n<8;n++)
1099   2                      {
1100   3                              if((myTxRxData[i]&0x80)==0x80)//Îª1
1101   3                              {
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 19  

1102   4                                      P10=0;
1103   4                                      Delay3(120);//ÑÓÊ±4.5msÒÔÉÏ£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
1104   4                              }
1105   3                              else//Îª0µÄÇé¿ö
1106   3                              {
1107   4                                      P10=0;
1108   4                                      Delay3(80);//ÑÓÊ±2ms£¬ÓÉÓÚ¶¨Ê±Æ÷Õ¼ÓÃÎÊÌâ£¬Ö»ÄÜÓÃÕâÖÖÑÓÊ±À´ÊµÏÖ
1109   4                              }
1110   3                              P10=1;//³£Ì¬Îª¸ßµçÆ½
1111   3                              myTxRxData[i]<<=1;
1112   3                              Delay3(50);//ÑÓÊ±Òª´óÓÚ2ms
1113   3                      }
1114   2              }
1115   1      //      codeData(myTxRxData,7); //½øĞĞ±àÂë
1116   1      //      SendNByte(TxRxBuf,28);
1117   1      //      PWMCON0=0x00;//¹Ø±ÕPWM
1118   1      //      P0M1|=0x02;      //¸ß×èÄ£Ê½     £¬Ïàµ±¹Ø·¢Éä»ú
1119   1      //      P0M2&=0xfd;
1120   1      //      ModeTurn=1;     
1121   1      }
1122          
1123          /*
1124          void codeData(unsigned char *doData,unsigned char len)          //±àÂë ,µçÆ½1±äÎª0011£¬µçÆ½0±äÎª1100
1125          {
1126                  unsigned char n,j,i=0;
1127                  for(n=0;n<len;n++)
1128                  {       
1129                          for(j=0;j<8;j++)        
1130                          {
1131                                  if(j==0||j==1)
1132                                  {       
1133                                           TxRxBuf[i]<<=4;
1134                                          if((*doData&0x80)==0x80)
1135                                          {
1136                                                  TxRxBuf[i]|=0x03;       
1137                                          }
1138                                          else
1139                                          {
1140                                                  TxRxBuf[i]|=0x0c;
1141                                          }
1142                                          *doData<<=1;
1143                                  }
1144                                  else if(j==2||j==3)
1145                                  {
1146                                          TxRxBuf[i+1]<<=4;
1147                                          if((*doData&0x80)==0x80)
1148                                          {
1149                                                  TxRxBuf[i+1]|=0x03;     
1150                                          }
1151                                          else
1152                                          {
1153                                                  TxRxBuf[i+1]|=0x0c;
1154                                          }
1155                                          *doData<<=1;
1156                                  }
1157                                  else if(j==4||j==5)
1158                                  {
1159                                          TxRxBuf[i+2]<<=4;
1160                                          if((*doData&0x80)==0x80)
1161                                          {
1162                                                  TxRxBuf[i+2]|=0x03;             
1163                                          }
C51 COMPILER V9.01   NEWHOST                                                               04/10/2013 17:03:33 PAGE 20  

1164                                          else
1165                                          {
1166                                                  TxRxBuf[i+2]|=0x0c;
1167                                          }
1168                                          *doData<<=1;
1169                                  }
1170                                  else if(j==6||j==7)
1171                                  {
1172                                          TxRxBuf[i+3]<<=4;
1173                                          if((*doData&0x80)==0x80)
1174                                          {
1175                                                  TxRxBuf[i+3]|=0x03;                                             
1176                                          }
1177                                          else
1178                                          {
1179                                                  TxRxBuf[i+3]|=0x0c;                             
1180                                          }
1181                                          *doData<<=1;
1182                                  }
1183                          }
1184                          i+=4;
1185                          doData++;
1186                  }
1187          }
1188          */
1189          /*
1190          void transCode(unsigned char *doData,unsigned char len)//½âÂë£¬½«½ÓÊÕµ½µÃÊı¾İ»¹Ô­
1191          {
1192                  unsigned char i,j;
1193                  for(i=0;i<len;i++)
1194                  {
1195                          for(j=0;j<2;j++)
1196                          {
1197                                  myTxRxData[i/4]<<=1;
1198          
1199                                  if((*doData&0x30)==0x30)//ËµÃ÷Îª1
1200                                  {
1201                                          myTxRxData[i/4]|=0x01;
1202                                  }
1203                                  else if((*doData&0xc0)==0xc0)  //ËµÃ÷Îª0
1204                                  {
1205                                          myTxRxData[i/4]&=0xfe;  
1206                                  }
1207          
1208                                  *doData<<=4;
1209                          }
1210                          doData++;
1211                  }
1212          }
1213          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1678    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     67       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
